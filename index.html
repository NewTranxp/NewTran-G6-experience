<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>New Tran English App - Grade 6 Listening Mode</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg-gradient: linear-gradient(135deg, #fce38a, #f38181);
        --card-bg: #ffffffcc;
        --primary: #ff6f61;
        --primary-dark: #e65b4f;
        --accent: #45b7d1;
        --accent-soft: #e0f7ff;
        --text-main: #333;
      }
      * { box-sizing: border-box; }
      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        margin: 0; min-height: 100vh;
        background: var(--bg-gradient); color: var(--text-main);
      }
      .page { max-width: 960px; margin: 0 auto; padding: 16px 12px 40px; }
      h1 { text-align: center; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.18); margin: 8px 0 4px; font-size: 26px; }
      .subtitle { text-align: center; color: #fff; font-size: 13px; margin-bottom: 10px; }
      .card { background: var(--card-bg); backdrop-filter: blur(6px); border-radius: 16px; padding: 14px 16px; margin-top: 12px; box-shadow: 0 6px 14px rgba(0,0,0,0.15); }
      .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
      .pill { padding: 2px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; background: var(--accent-soft); color: #0077a3; white-space: nowrap; }
      .label { font-weight: 600; margin: 6px 0 2px; font-size: 14px; }
      input, select, textarea {
        width: 100%; border-radius: 10px; border: 1px solid #ddd;
        padding: 7px 9px; margin: 2px 0 8px; font-size: 14px; font-family: inherit;
        outline: none; transition: border 0.15s, box-shadow 0.15s;
      }
      input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(69, 183, 209, 0.25); }
      textarea { resize: vertical; min-height: 60px; }
      textarea[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }

      button {
        border: none; border-radius: 999px; padding: 8px 16px; font-size: 14px; font-weight: 600;
        cursor: pointer; font-family: inherit; display: inline-flex; align-items: center; gap: 6px;
        transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      }
      button:active { transform: translateY(1px); box-shadow: none; }
      .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(230, 91, 79, 0.45); }
      .btn-primary:hover { background: var(--primary-dark); }
      .btn-secondary { background: #fff; color: var(--primary); border: 1px solid rgba(0,0,0,0.06); }
      .btn-secondary:disabled, .btn-primary:disabled { opacity: 0.65; cursor: default; box-shadow: none; }
      .btn-danger { background: #ff4444; color: white; box-shadow: 0 4px 10px rgba(255, 68, 68, 0.4); }
      .btn-danger:hover { background: #cc0000; }

      .small { font-size: 12px; color: #666; }
      .status { font-size: 13px; margin-top: 4px; font-weight: 500; }
      .status-ok { color: #1b8f3b; }
      .status-error { color: #c62828; }
      .flex-row { display: flex; gap: 8px; flex-wrap: wrap; }
      .flex-row > div { flex: 1 1 150px; }
      .question-list {
        margin-top: 6px; border-radius: 10px; background: #fff; border: 1px solid #eee;
        max-height: 210px; overflow-y: auto; padding: 6px 6px 4px;
      }
      .question-item { padding: 6px 8px; border-radius: 8px; margin-bottom: 4px; font-size: 13px; cursor: pointer; display: flex; gap: 6px; }
      .question-item span.q-no { font-weight: 700; color: var(--accent); min-width: 52px; }
      .question-item:hover { background: #f3f9ff; }
      .question-item.active { background: #e1f2ff; border-left: 3px solid var(--accent); }
      .badge-part { font-size: 11px; padding: 1px 8px; border-radius: 999px; background: rgba(255,255,255,0.9); color: #555; border: 1px dashed #ddd; }
      .footer { text-align: center; font-size: 11px; color: #fff; margin-top: 18px; opacity: 0.9; }

      .btn-speak { background: #4caf50; color: #fff; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }
      .btn-speak:hover { background: #43a047; }

      #questionTextContainer { display: none; animation: fadeIn 0.3s; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      .marquee { width: 100%; overflow: hidden; white-space: nowrap; box-sizing: border-box; background: rgba(255,255,255,0.18); padding: 6px 0; margin-bottom: 6px; border-radius: 8px; backdrop-filter: blur(3px); }
      .marquee span { display: inline-block; padding-left: 100%; font-weight: bold; color: #d50000; font-size: 16px; animation: marqueeAnim 14s linear infinite; }
      @keyframes marqueeAnim { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }

      #inapp-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 9999; color: white;
        display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
      }
      .arrow-up { font-size: 40px; margin-bottom: 10px; animation: bounce 1s infinite; position: absolute; top: 20px; right: 20px; }
      @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

      .mini-banner {
        border-radius: 12px; padding: 10px 12px; background: rgba(255,255,255,0.8);
        border: 1px solid rgba(0,0,0,0.06); margin-top: 10px;
      }

      /* Upload Progress */
      .upload-progress {
        display: none;
        margin-top: 12px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
        border: 1px solid #ddd;
      }
      .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 13px;
        font-weight: 500;
      }
      .progress-bar-container {
        width: 100%;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
      }
      .progress-bar {
        width: 0%;
        height: 100%;
        background: #4caf50;
        transition: width 0.3s ease;
      }

      /* Countdown timer (still keep the detail box) */
      .timer-box {
        display: none;
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.85);
        border: 1px solid rgba(0,0,0,0.08);
        font-size: 13px;
      }
      .timer-box strong { color: #c62828; }
      .timer-warn {
        margin-top: 6px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(255, 243, 224, 0.95);
        border-left: 4px solid #ff9800;
        font-size: 12px;
        color: #444;
        display: none;
      }

      /* BIG TIMER right next to Start button */
      .timer-inline{
        display:none;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(255,255,255,0.9);
        border: 2px solid rgba(198,40,40,0.25);
        font-weight: 900;
        font-size: 22px;
        letter-spacing: 1px;
        color: #c62828;
        line-height: 1;
        min-width: 92px;
        text-align: center;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>

  <body>
    <div id="inapp-overlay">
      <div class="arrow-up">‚Üó</div>
      <h3>‚ö†Ô∏è C·∫£nh b√°o tr√¨nh duy·ªát</h3>
      <p>B·∫°n ƒëang m·ªü link n√†y tr√™n Zalo/Facebook.</p>
      <p>Microphone s·∫Ω <strong>kh√¥ng ho·∫°t ƒë·ªông</strong> ·ªü ƒë√¢y.</p>
      <p style="background:#444; padding:10px; border-radius:8px; margin-top:15px;">
        Vui l√≤ng nh·∫•n v√†o d·∫•u <strong>3 ch·∫•m (...)</strong> ·ªü g√≥c tr√™n c√πng b√™n ph·∫£i v√† ch·ªçn
        <br><strong>"M·ªü b·∫±ng tr√¨nh duy·ªát" (Open in Browser)</strong>.
      </p>
    </div>

    <div class="marquee">
      <span>‚òÖ Mr. T√¢n Tr·∫ßn Ng·ªçc ‚Äì Xu√¢n Ph√∫ lower secondary school ‚òÖ</span>
    </div>

    <div class="page">
      <h1>New Tran English App</h1>
      <div class="subtitle">Luy·ªán n√≥i ti·∫øng Anh ‚Äì Grade 6 (Listening Mode)</div>

      <div id="pendingBox" class="mini-banner" style="display:none;">
        <div><strong>‚ö†Ô∏è C√≥ 1 b√†i ch∆∞a g·ª≠i xong (ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c)</strong></div>
        <div class="small" id="pendingInfo"></div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="resendPendingBtn" class="btn-primary" type="button">üì§ G·ª≠i l·∫°i b√†i v·ª´a l∆∞u</button>
          <button id="clearPendingBtn" class="btn-secondary" type="button">üßπ X√≥a b√†i l∆∞u</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 0</div>
          <div><strong>Th√¥ng tin h·ªçc sinh</strong></div>
        </div>
        <div class="flex-row">
          <div>
            <div class="label">H·ªç v√† t√™n:</div>
            <input id="studentName" placeholder="Nguy·ªÖn VƒÉn Nam" />
          </div>
          <div>
            <div class="label">L·ªõp:</div>
            <input id="studentClass" placeholder="6A" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 1</div>
          <div><strong>Ch·ªçn b√†i luy·ªán n√≥i</strong></div>
        </div>
        <div class="flex-row">
          <div>
            <div class="label">Kh·ªëi l·ªõp:</div>
            <select id="gradeSelect"></select>
          </div>
          <div>
            <div class="label">Ch·ªß ƒë·ªÅ:</div>
            <select id="topicSelect"></select>
          </div>
        </div>
        <div class="flex-row">
          <div>
            <div class="label">Ph·∫ßn:</div>
            <select id="partSelect">
              <option value="part1">Part I. Answer personal questions</option>
              <option value="part2">Part II. Talk about the topic</option>
              <option value="part3">Part III. Answer questions about topic</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end;">
            <span class="badge-part" id="partNote"></span>
          </div>
        </div>
        <div class="label">Danh s√°ch c√¢u h·ªèi (B·∫•m v√†o ƒë·ªÉ ch·ªçn):</div>
        <div class="question-list" id="questionList"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 2</div>
          <div><strong>Nghe & Hi·ªÉu c√¢u h·ªèi</strong></div>
        </div>

        <div class="flex-row" style="align-items: center; margin-bottom: 10px;">
          <button id="speakQuestionBtn" class="btn-speak" type="button">üîä Nghe c√¢u h·ªèi (Listen)</button>
          <button id="showTextBtn" class="btn-secondary" type="button">üëÅÔ∏è Kh√¥ng nghe ƒë∆∞·ª£c? Hi·ªán vƒÉn b·∫£n</button>
        </div>

        <div id="questionTextContainer">
          <div class="label">N·ªôi dung c√¢u h·ªèi:</div>
          <textarea id="question" rows="3" readonly style="background:#f9f9f9; color:#555;"></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 3</div>
          <div><strong>Tr·∫£ l·ªùi & G·ª≠i</strong></div>
        </div>

        <div class="flex-row" style="align-items:center;margin-bottom:4px;">
          <button id="startBtn" class="btn-primary" type="button">üéô B·∫Øt ƒë·∫ßu n√≥i</button>

          <!-- BIG TIMER right next to Start -->
          <div id="timerInline" class="timer-inline" aria-live="polite">08:00</div>

          <button id="stopBtn" class="btn-secondary" type="button" disabled>‚èπ D·ª´ng & Qua c√¢u ti·∫øp theo</button>
        </div>

        <div id="status" class="status">Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.</div>

        <!-- Keep detail timer box (optional, for clarity) -->
        <div id="timerBox" class="timer-box">
          ‚è≥ Th·ªùi gian c√≤n l·∫°i (t·ªïng 10 c√¢u): <strong id="timerText">08:00</strong>
        </div>
        <div id="leaveHint" class="timer-warn">
          Khi b·∫°n b·∫•m <strong>N·ªôp b√†i</strong>, h·ªá th·ªëng s·∫Ω g·ª≠i audio l√™n Drive c·ªßa gi√°o vi√™n. B·∫°n c√≥ th·ªÉ r·ªùi trang trong khi qu√° tr√¨nh g·ª≠i ƒëang di·ªÖn ra; b√†i s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°m ƒë·ªÉ g·ª≠i l·∫°i n·∫øu c√≥ l·ªói k·∫øt n·ªëi/gi·ªõi h·∫°n tr√¨nh duy·ªát.
        </div>

        <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #4caf50;">
          <strong>üì¢ L∆∞u √Ω:</strong> ·ª®ng d·ª•ng ch·ªâ y√™u c·∫ßu <strong>n√≥i (ghi √¢m)</strong>. Kh√¥ng c·∫ßn nh·∫≠p vƒÉn b·∫£n.
        </div>

        <!-- Transcript ·∫©n (kh√¥ng d√πng) -->
        <div style="display: none;">
          <div class="label">Transcript (HS n√≥i):</div>
          <textarea
            id="answerText"
            rows="5"
            readonly
            placeholder="VƒÉn b·∫£n s·∫Ω t·ª± ƒë·ªông hi·ªán khi b·∫°n n√≥i... (Kh√¥ng th·ªÉ t·ª± g√µ)"
            style="background-color:#f0f8ff;"
          ></textarea>

          <div class="flex-row" style="align-items:center; gap:8px; margin-top: 5px;">
            <button id="clearBtn" class="btn-danger" type="button">üóë X√≥a c√¢u tr·∫£ l·ªùi n√†y</button>
          </div>
        </div>

        <br />

        <div class="flex-row" style="align-items:center; gap:8px;">
          <button id="sendBtn" class="btn-primary" type="button">üì© N·ªôp b√†i cho GV</button>
          <button id="suggestBtn" class="btn-secondary" type="button" disabled>üí° Xem g·ª£i √Ω tr·∫£ l·ªùi</button>
        </div>

        <!-- Upload Progress -->
        <div id="uploadProgress" class="upload-progress">
          <div class="progress-header">
            <span>ƒêang t·∫£i l√™n...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>K·∫øt qu·∫£ g·ª≠i</h2>
        <div id="resultArea" class="small">Ch∆∞a g·ª≠i.</div>
      </div>

      <div class="card">
        <h2>G·ª£i √Ω tr·∫£ l·ªùi / Suggested Answer</h2>
        <div id="suggestionsArea" class="small" style="white-space: pre-line;"></div>
      </div>

      <div class="footer">¬© New Tran English App ‚Äì T√¢n Tr·∫ßn Ng·ªçc &amp; Google Apps Script</div>
    </div>

    <script>
      // ===================== APPS SCRIPT URL (FINAL) =====================
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZ48S-PVLSK-ZpXvbITFx6MTL_uG6dvwCqwyyzuzqonZGqudpFwaohsSQkF2QYBxuM/exec";
      // ===================================================================

      const TOTAL_QUESTIONS = 10;

      // ======= l∆∞u b√†i khi g·ª≠i l·ªói =======
      const PENDING_KEY = "NEWTRAN_PENDING_SUBMISSION_V1";
      // ======= l∆∞u audio blob (IndexedDB) =======
      const PENDING_AUDIO_DB = "NEWTRAN_PENDING_AUDIO_DB_V1";
      const PENDING_AUDIO_STORE = "blobs";

      // ======= ch·ªëng qu√° dung l∆∞·ª£ng (base64) =======
      const MAX_DATAURL_CHARS = 28_000_000;
      const SMALL_BLOB_MAX = 4 * 1024 * 1024; // <= 4MB: g·ª≠i dataUrl; >4MB: d√πng chunk upload

      // ===== Countdown 8 minutes TOTAL for all 10 questions =====
      const RECORD_LIMIT_SEC = 8 * 60;
      let recordDeadlineTs = null;
      let recordTimer = null;
      let timeLocked = false;

      // ===== Upload in progress flag (warn) =====
      let uploadInProgress = false;

      // ========== helpers ==========
      function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
      function formatMMSS(sec){
        sec = Math.max(0, Math.floor(sec));
        const m = Math.floor(sec/60);
        const s = sec % 60;
        return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
      }
      function getRemainingSeconds(){
        if (!recordDeadlineTs) return RECORD_LIMIT_SEC;
        return Math.max(0, Math.floor((recordDeadlineTs - Date.now()) / 1000));
      }
      function lockByTimeUp(){
        timeLocked = true;
        try { pauseFullRecording(); } catch(e){}
        isRecording = false;
        startBtn.disabled = true;
        stopBtn.disabled = true;
        speakQuestionBtn.disabled = true;
        statusEl.textContent = "‚õî H·∫øt th·ªùi gian (8 ph√∫t cho t·ªïng 10 c√¢u). B·∫°n kh√¥ng th·ªÉ tr·∫£ l·ªùi th√™m.";
        alert("H·∫øt th·ªùi gian l√†m b√†i (8 ph√∫t cho t·ªïng 10 c√¢u). B·∫°n kh√¥ng th·ªÉ tr·∫£ l·ªùi th√™m.");
      }
      function tickTimer(){
        const remain = getRemainingSeconds();
        const txt = formatMMSS(remain);
        timerText.textContent = txt;

        if (timerInline) {
          timerInline.textContent = txt;
          timerInline.style.display = "inline-flex";
        }

        timerBox.style.display = "block";

        if (remain <= 0) {
          clearInterval(recordTimer);
          recordTimer = null;
          if (!timeLocked) lockByTimeUp();
        }
      }
      function startCountdownIfNeeded(){
        if (timeLocked) return;
        if (!recordDeadlineTs) {
          recordDeadlineTs = Date.now() + RECORD_LIMIT_SEC * 1000;
          timerBox.style.display = "block";
          tickTimer();
          if (!recordTimer) recordTimer = setInterval(tickTimer, 250);
        }
      }

      function pickSupportedMime() {
        const candidates = ["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"];
        if (!window.MediaRecorder) return "";
        for (const t of candidates) {
          try { if (MediaRecorder.isTypeSupported(t)) return t; } catch (e) {}
        }
        return "";
      }

      async function ensureMicStream() {
        if (micStream) return micStream;
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return micStream;
      }

      function allTenQuestionsRecorded() {
        for (let i = 0; i < TOTAL_QUESTIONS; i++) if (!recordedFlags[i]) return false;
        return true;
      }

      function blobToDataUrl(blob, cb) {
        const fr = new FileReader();
        fr.onload = () => cb(fr.result);
        fr.onerror = () => cb(null);
        fr.readAsDataURL(blob);
      }

      // ===================== IndexedDB helpers (store audio safely) =====================
      function openPendingAudioDb() {
        return new Promise((resolve, reject) => {
          try {
            const req = indexedDB.open(PENDING_AUDIO_DB, 1);
            req.onupgradeneeded = () => {
              const db = req.result;
              if (!db.objectStoreNames.contains(PENDING_AUDIO_STORE)) {
                db.createObjectStore(PENDING_AUDIO_STORE);
              }
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
          } catch (e) { reject(e); }
        });
      }

      async function idbSetBlob(key, blob) {
        const db = await openPendingAudioDb();
        return new Promise((resolve, reject) => {
          try {
            const tx = db.transaction(PENDING_AUDIO_STORE, "readwrite");
            tx.objectStore(PENDING_AUDIO_STORE).put(blob, key);
            tx.oncomplete = () => { try { db.close(); } catch(e){} resolve(true); };
            tx.onerror = () => { try { db.close(); } catch(e){} reject(tx.error); };
          } catch (e) {
            try { db.close(); } catch(_) {}
            reject(e);
          }
        });
      }

      async function idbGetBlob(key) {
        const db = await openPendingAudioDb();
        return new Promise((resolve, reject) => {
          try {
            const tx = db.transaction(PENDING_AUDIO_STORE, "readonly");
            const req = tx.objectStore(PENDING_AUDIO_STORE).get(key);
            req.onsuccess = () => { try { db.close(); } catch(e){} resolve(req.result || null); };
            req.onerror = () => { try { db.close(); } catch(e){} reject(req.error); };
          } catch (e) {
            try { db.close(); } catch(_) {}
            reject(e);
          }
        });
      }

      async function idbDelBlob(key) {
        const db = await openPendingAudioDb();
        return new Promise((resolve) => {
          try {
            const tx = db.transaction(PENDING_AUDIO_STORE, "readwrite");
            tx.objectStore(PENDING_AUDIO_STORE).delete(key);
            tx.oncomplete = () => { try { db.close(); } catch(e){} resolve(true); };
            tx.onerror = () => { try { db.close(); } catch(e){} resolve(false); };
          } catch (e) {
            try { db.close(); } catch(_) {}
            resolve(false);
          }
        });
      }

      // ===================== CHUNK UPLOAD (NO-CORS) =====================
      function uint8ToBase64(u8) {
        let binary = "";
        const chunk = 0x8000;
        for (let i = 0; i < u8.length; i += chunk) {
          binary += String.fromCharCode.apply(null, u8.subarray(i, i + chunk));
        }
        return btoa(binary);
      }

      async function uploadAudioInChunksNoCors(blob, mimeType, meta) {
        const uploadId = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const bytes = new Uint8Array(await blob.arrayBuffer());

        const ua = navigator.userAgent || "";
        const isIOS = /iPad|iPhone|iPod/.test(ua);
        const chunkBytes = isIOS ? (200 * 1024) : (512 * 1024);
        const total = Math.ceil(bytes.length / chunkBytes);

        uploadProgress.style.display = "block";
        progressBar.style.width = "0%";
        progressPercent.textContent = "0%";
        uploadInProgress = true;

        const uploadChunkWithRetry = async (idx, b64, retries = 3) => {
          for (let attempt = 0; attempt < retries; attempt++) {
            try {
              await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                keepalive: false, // IMPORTANT: avoid false "network" errors on large bodies
                body: JSON.stringify({
                  action: "uploadChunk",
                  uploadId,
                  idx,
                  total,
                  mimeType,
                  b64
                })
              });
              return true;
            } catch (err) {
              if (attempt < retries - 1) await sleep(400 * (attempt + 1));
            }
          }
          return false;
        };

        for (let idx = 0; idx < total; idx++) {
          const start = idx * chunkBytes;
          const end = Math.min(start + chunkBytes, bytes.length);
          const part = bytes.subarray(start, end);
          const b64 = uint8ToBase64(part);

          const ok = await uploadChunkWithRetry(idx, b64);
          if (!ok) {
            uploadInProgress = false;
            throw new Error(`Failed to upload chunk ${idx + 1}/${total}`);
          }

          const percent = Math.round(((idx + 1) / total) * 100);
          progressBar.style.width = `${percent}%`;
          progressPercent.textContent = `${percent}%`;
          await sleep(80);
        }

        const finalizeWithRetry = async (retries = 3) => {
          for (let attempt = 0; attempt < retries; attempt++) {
            try {
              await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                keepalive: false, // IMPORTANT
                body: JSON.stringify({
                  action: "finalizeUpload",
                  uploadId,
                  total,
                  mimeType,
                  ...meta
                })
              });
              return { ok: true, uploadId, total };
            } catch (err) {
              if (attempt < retries - 1) await sleep(800 * (attempt + 1));
            }
          }
          throw new Error("Failed to finalize upload after all retries");
        };

        const result = await finalizeWithRetry();
        uploadInProgress = false;

        setTimeout(() => { uploadProgress.style.display = "none"; }, 800);
        return result;
      }

      // ===================== WAV FALLBACK (WebAudio) =====================
      const WAV_TARGET_RATE = 16000;
      let wavCtx = null;
      let wavSource = null;
      let wavProcessor = null;
      let wavGain0 = null;
      let wavPaused = true;
      let wavBuffers = [];
      let wavInputRate = 48000;

      function downsampleBuffer(inputFloat32, inRate, outRate) {
        if (outRate === inRate) return inputFloat32;
        if (outRate > inRate) return inputFloat32;
        const ratio = inRate / outRate;
        const newLen = Math.round(inputFloat32.length / ratio);
        const result = new Float32Array(newLen);
        let offsetResult = 0;
        let offsetBuffer = 0;
        while (offsetResult < result.length) {
          const nextOffsetBuffer = Math.round((offsetResult + 1) * ratio);
          let accum = 0, count = 0;
          for (let i = offsetBuffer; i < nextOffsetBuffer && i < inputFloat32.length; i++) {
            accum += inputFloat32[i];
            count++;
          }
          result[offsetResult] = count ? (accum / count) : 0;
          offsetResult++;
          offsetBuffer = nextOffsetBuffer;
        }
        return result;
      }

      function floatTo16BitPCM(float32Array) {
        const out = new Int16Array(float32Array.length);
        for (let i = 0; i < float32Array.length; i++) {
          let s = Math.max(-1, Math.min(1, float32Array[i]));
          out[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return out;
      }

      function encodeWav(int16Data, sampleRate) {
        const buffer = new ArrayBuffer(44 + int16Data.length * 2);
        const view = new DataView(buffer);
        function writeString(offset, str){
          for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
        }
        const numChannels = 1;
        const bitsPerSample = 16;
        const byteRate = sampleRate * numChannels * bitsPerSample / 8;
        const blockAlign = numChannels * bitsPerSample / 8;
        const dataSize = int16Data.length * 2;

        writeString(0, "RIFF");
        view.setUint32(4, 36 + dataSize, true);
        writeString(8, "WAVE");
        writeString(12, "fmt ");
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);
        writeString(36, "data");
        view.setUint32(40, dataSize, true);

        let offset = 44;
        for (let i = 0; i < int16Data.length; i++, offset += 2) {
          view.setInt16(offset, int16Data[i], true);
        }
        return new Blob([buffer], { type: "audio/wav" });
      }

      async function startWavRecordingIfNeeded() {
        if (isFullRecordingStarted && recorderMode === "wav") return;
        await ensureMicStream();
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) throw new Error("WebAudio not supported");
        wavCtx = new AudioCtx({ latencyHint: "interactive" });
        try { await wavCtx.resume(); } catch(e){}

        wavInputRate = wavCtx.sampleRate || 48000;
        wavBuffers = [];
        wavPaused = true;

        wavSource = wavCtx.createMediaStreamSource(micStream);
        const bufferSize = 4096;
        wavProcessor = wavCtx.createScriptProcessor(bufferSize, 1, 1);

        wavGain0 = wavCtx.createGain();
        wavGain0.gain.value = 0;

        wavProcessor.onaudioprocess = (e) => {
          if (wavPaused) return;
          try {
            const input = e.inputBuffer.getChannelData(0);
            const down = downsampleBuffer(input, wavInputRate, WAV_TARGET_RATE);
            const pcm16 = floatTo16BitPCM(down);
            wavBuffers.push(pcm16);
          } catch(err) {}
        };

        wavSource.connect(wavProcessor);
        wavProcessor.connect(wavGain0);
        wavGain0.connect(wavCtx.destination);

        recorderMode = "wav";
        audioMimeType = "audio/wav";
        isFullRecordingStarted = true;
      }

      function stopWavRecording(cb) {
        try { wavPaused = true; } catch(e){}
        try { if (wavProcessor) wavProcessor.disconnect(); } catch(e){}
        try { if (wavSource) wavSource.disconnect(); } catch(e){}
        try { if (wavGain0) wavGain0.disconnect(); } catch(e){}

        const chunks = wavBuffers || [];
        let totalLen = 0;
        for (const a of chunks) totalLen += a.length;

        const merged = new Int16Array(totalLen);
        let off = 0;
        for (const a of chunks) { merged.set(a, off); off += a.length; }

        const blob = encodeWav(merged, WAV_TARGET_RATE);

        const ctxToClose = wavCtx;
        wavCtx = null; wavSource = null; wavProcessor = null; wavGain0 = null;
        wavBuffers = [];
        if (ctxToClose) { try { ctxToClose.close(); } catch(e) {} }

        cb && cb(blob);
      }

      // =================== MediaRecorder path ===================
      let mediaRecorder = null;
      let audioChunks = [];
      let fullAudioBlob = null;

      async function startMediaRecordingIfNeeded() {
        if (isFullRecordingStarted && recorderMode === "media" && mediaRecorder) return;
        if (!window.MediaRecorder) throw new Error("MediaRecorder not supported");
        await ensureMicStream();

        audioMimeType = pickSupportedMime() || "";
        audioChunks = [];
        fullAudioBlob = null;

        mediaRecorder = new MediaRecorder(
          micStream,
          audioMimeType ? { mimeType: audioMimeType } : undefined
        );

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          try { fullAudioBlob = new Blob(audioChunks, { type: (audioMimeType || "audio/webm") }); } catch (e) {}
        };

        try { mediaRecorder.start(1000); } catch(e) { mediaRecorder.start(); }

        recorderMode = "media";
        isFullRecordingStarted = true;
      }

      // ========= unified control =========
      async function startFullRecordingIfNeeded() {
        try { await startMediaRecordingIfNeeded(); }
        catch (e) { await startWavRecordingIfNeeded(); }
      }

      function pauseFullRecording() {
        if (!isFullRecordingStarted) return;
        if (recorderMode === "media" && mediaRecorder) {
          if (mediaRecorder.state === "recording") { try { mediaRecorder.pause(); } catch(e){} }
        } else if (recorderMode === "wav") {
          wavPaused = true;
        }
      }

      function resumeFullRecording() {
        if (!isFullRecordingStarted) return;
        if (recorderMode === "media" && mediaRecorder) {
          if (mediaRecorder.state === "paused") { try { mediaRecorder.resume(); } catch(e){} }
        } else if (recorderMode === "wav") {
          wavPaused = false;
        }
      }

      function stopFullRecording(cb) {
        if (!isFullRecordingStarted) { cb && cb(null); return; }
        if (recorderMode === "media" && mediaRecorder) {
          try { mediaRecorder.requestData(); } catch(e){}
          const prevOnStop = mediaRecorder.onstop;
          mediaRecorder.onstop = () => {
            try { fullAudioBlob = new Blob(audioChunks, { type: (audioMimeType || "audio/webm") }); } catch (e) {}
            mediaRecorder.onstop = prevOnStop;
            cb && cb(fullAudioBlob);
          };
          try { mediaRecorder.stop(); } catch (e) { cb && cb(null); }
        } else if (recorderMode === "wav") {
          stopWavRecording(cb);
        } else {
          cb && cb(null);
        }
      }

      // ========= SpeechRecognition (T·∫ÆT HO√ÄN TO√ÄN) =========
      let recognition = null;
      function initSpeech() { recognition = null; }

      // ========= iOS/Safari TTS English voice fix =========
      let englishVoice = null;
      let pendingSpeakText = null;

      function selectEnglishVoice() {
        if (!("speechSynthesis" in window)) return null;
        const voices = window.speechSynthesis.getVoices();
        if (!voices || !voices.length) return null;

        const preferredNames = ["Samantha", "Karen", "Daniel", "Moira", "Serena", "Martha"];

        let v =
          voices.find(v => preferredNames.includes(v.name)) ||
          voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-us")) ||
          voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-gb")) ||
          voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en"));

        englishVoice = v || null;
        return englishVoice;
      }

      if ("speechSynthesis" in window) {
        window.speechSynthesis.onvoiceschanged = function () {
          const hadPending = !!pendingSpeakText;
          selectEnglishVoice();
          if (englishVoice && hadPending) {
            const text = pendingSpeakText;
            pendingSpeakText = null;
            speakText(text);
          }
        };
      }

      function speakText(text) {
        if (!("speechSynthesis" in window)) return;

        // Pause recording while speaking (gi·ªØ t√≠nh nƒÉng ·ªïn ƒë·ªãnh iOS)
        pauseFullRecording();
        window.speechSynthesis.cancel();

        if (!englishVoice) {
          const v = selectEnglishVoice();
          if (!v) {
            pendingSpeakText = text;
            window.speechSynthesis.getVoices();
            return;
          }
        }

        const numberWords = {
          "0": "zero", "1": "one", "2": "two", "3": "three", "4": "four",
          "5": "five", "6": "six", "7": "seven", "8": "eight", "9": "nine", "10": "ten"
        };
        const processedText = text.replace(/Question\s+(\d+)/gi, (match, num) => {
          const w = numberWords[num];
          return w ? "Question " + w : match;
        });

        setTimeout(() => {
          const langCode = englishVoice && englishVoice.lang ? englishVoice.lang : "en-US";
          const u = new SpeechSynthesisUtterance(processedText);
          u.lang = langCode;
          u.rate = 0.9;
          if (englishVoice) u.voice = englishVoice;
          window.speechSynthesis.speak(u);

          setTimeout(() => { resumeFullRecording(); }, 100);
        }, 50);
      }

      // ======= in-app block =======
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isInApp = ua.indexOf("FBAN") > -1 || ua.indexOf("FBAV") > -1 || ua.indexOf("Zalo") > -1;
      if (isInApp) document.getElementById("inapp-overlay").style.display = "flex";

      // ================== D·ªÆ LI·ªÜU KH·ªêI 6 ==================
      const GRADES = [
        {
          id: "6",
          name: "Grade 6",
          topics: [
            { id: "g6_my_new_school",      name: "My New School",               vn: "Ng√¥i tr∆∞·ªùng m·ªõi c·ªßa em" },
            { id: "g6_my_house",           name: "My House",                    vn: "Ng√¥i nh√† c·ªßa em" },
            { id: "g6_my_friends",         name: "My Friends",                  vn: "Nh·ªØng ng∆∞·ªùi b·∫°n c·ªßa em" },
            { id: "g6_my_neighbourhood",   name: "My Neighbourhood",            vn: "Khu d√¢n c∆∞ c·ªßa em" },
            { id: "g6_natural_wonders",    name: "Natural Wonders of Viet Nam", vn: "C√°c k·ª≥ quan thi√™n nhi√™n c·ªßa Vi·ªát Nam" },
            { id: "g6_our_tet_holiday",    name: "Our Tet Holiday",             vn: "K·ª≥ ngh·ªâ T·∫øt c·ªßa ch√∫ng t√¥i" },
            { id: "g6_television",         name: "Television",                  vn: "Truy·ªÅn h√¨nh" },
            { id: "g6_sports_games",       name: "Sports and Games",            vn: "Th·ªÉ thao v√† tr√≤ ch∆°i" },
            { id: "g6_cities_world",       name: "Cities of the World",         vn: "C√°c th√†nh ph·ªë tr√™n th·∫ø gi·ªõi" },
            { id: "g6_houses_future",      name: "Our Houses in the Future",    vn: "Ng√¥i nh√† t∆∞∆°ng lai c·ªßa ch√∫ng ta" },
            { id: "g6_our_greener_world",  name: "Our Greener World",           vn: "Th·∫ø gi·ªõi xanh h∆°n c·ªßa ch√∫ng ta" },
            { id: "g6_robots",             name: "Robots",                      vn: "Ng∆∞·ªùi m√°y / R√¥-b·ªët" }
          ]
        }
      ];

      const GRADE_6_QUESTIONS = {
        g6_my_new_school: {
          part1: [
            "Question 1. What's the name of your school?",
            "Question 2. Where is your school?",
            "Question 3. Who is your favorite teacher?",
            "Question 4. What subject do you like the most?",
            "Question 5. How do you go to school every day?"
          ],
          part2: ["Question 6. Please tell me about your new school."],
          part3: [
            "Question 7. What do you do at break time?",
            "Question 8. Do you think wearing a school uniform is important?",
            "Question 9. What makes a good student?",
            "Question 10. What would you like to change in your school?"
          ]
        },

        g6_my_house: {
          part1: [
            "Question 1. Where do you live?",
            "Question 2. How many rooms are there in your house?",
            "Question 3. Which room do you like the most?",
            "Question 4. Who do you live with?",
            "Question 5. What do you usually do at home?"
          ],
          part2: ["Question 6. Please tell me about your house."],
          part3: [
            "Question 7. Why is it important to keep your house clean?",
            "Question 8. Do you prefer living in a house or an apartment?",
            "Question 9. What would your dream house be like?",
            "Question 10. How do you help your family at home?"
          ]
        },

        g6_my_friends: {
          part1: [
            "Question 1. Who is your best friend?",
            "Question 2. How did you meet your best friend?",
            "Question 3. What do you and your friends usually do together?",
            "Question 4. What do you like about your friends?",
            "Question 5. How often do you see your friends?"
          ],
          part2: ["Question 6. Please tell me about your friends."],
          part3: [
            "Question 7. What makes a good friend?",
            "Question 8. Do you think it is important to have many friends?",
            "Question 9. How do you help your friends when they have a problem?",
            "Question 10. What activities help students make new friends?"
          ]
        },

        g6_my_neighbourhood: {
          part1: [
            "Question 1. Do you live in the countryside or the city?",
            "Question 2. What is your neighbourhood like?",
            "Question 3. What places are near your house?",
            "Question 4. Who do you often meet in your neighbourhood?",
            "Question 5. What do you like most about your neighbourhood?"
          ],
          part2: ["Question 6. Please tell me about your neighbourhood."],
          part3: [
            "Question 7. What makes a neighbourhood a good place to live?",
            "Question 8. Should students help keep their neighbourhood clean?",
            "Question 9. How can people make a neighbourhood safer?",
            "Question 10. What changes would you like to see in your neighbourhood?"
          ]
        },

        g6_natural_wonders: {
          part1: [
            "Question 1. Have you ever visited a natural wonder?",
            "Question 2. What natural wonder in Viet Nam do you know?",
            "Question 3. Which natural place would you like to visit?",
            "Question 4. Who would you go with to visit a natural wonder?",
            "Question 5. How do you feel when visiting beautiful places?"
          ],
          part2: ["Question 6. Please tell me about a natural wonder in Viet Nam."],
          part3: [
            "Question 7. Why should we protect natural wonders?",
            "Question 8. How can tourism affect natural places?",
            "Question 9. What can students do to promote Viet Nam's natural wonders?",
            "Question 10. What natural wonder would you like to explore in the future?"
          ]
        },

        g6_our_tet_holiday: {
          part1: [
            "Question 1. What do you usually do during Tet?",
            "Question 2. What food do you eat at Tet?",
            "Question 3. Who do you visit during Tet?",
            "Question 4. What activities do you enjoy most at Tet?",
            "Question 5. What do you like getting at Tet?"
          ],
          part2: ["Question 6. Please tell me about your Tet holiday."],
          part3: [
            "Question 7. Why is Tet important in Viet Nam?",
            "Question 8. How do people prepare for Tet?",
            "Question 9. What customs should children follow at Tet?",
            "Question 10. How can we keep Tet traditions alive?"
          ]
        },

        g6_television: {
          part1: [
            "Question 1. How often do you watch TV?",
            "Question 2. What is your favorite TV programme?",
            "Question 3. Who do you usually watch TV with?",
            "Question 4. How many hours a day do you watch TV?",
            "Question 5. What do you learn from TV?"
          ],
          part2: ["Question 6. Please tell me about your TV habits."],
          part3: [
            "Question 7. Is watching TV good for students? Why?",
            "Question 8. What kinds of programmes should students watch?",
            "Question 9. How can we use TV time wisely?",
            "Question 10. Do you think TV will change in the future?"
          ]
        },

        g6_sports_games: {
          part1: [
            "Question 1. What sports do you like?",
            "Question 2. How often do you play sports?",
            "Question 3. Who do you play sports with?",
            "Question 4. What game do you enjoy most?",
            "Question 5. Do you often watch sports on TV?"
          ],
          part2: ["Question 6. Please tell me about your favorite sport or game."],
          part3: [
            "Question 7. Why are sports important for students?",
            "Question 8. What sports help you stay healthy?",
            "Question 9. Should students play sports every day?",
            "Question 10. What new sport would you like to try?"
          ]
        },

        g6_cities_world: {
          part1: [
            "Question 1. What city do you live in?",
            "Question 2. What cities do you know around the world?",
            "Question 3. Which city would you like to visit?",
            "Question 4. Who would you travel with?",
            "Question 5. What do you like doing when visiting a city?"
          ],
          part2: ["Question 6. Please tell me about a city you know."],
          part3: [
            "Question 7. What makes a city beautiful?",
            "Question 8. How can cities become cleaner?",
            "Question 9. Why do people like living in big cities?",
            "Question 10. What city would you like to explore in the future?"
          ]
        },

        g6_houses_future: {
          part1: [
            "Question 1. What is your house like now?",
            "Question 2. What do you want your future house to have?",
            "Question 3. Where would you like your future house to be?",
            "Question 4. Who would you live with in the future?",
            "Question 5. What technology do you want in your future house?"
          ],
          part2: ["Question 6. Please tell me about your future house."],
          part3: [
            "Question 7. Why do people want modern houses?",
            "Question 8. How can smart houses help people?",
            "Question 9. What will houses look like in the future?",
            "Question 10. What future home invention would you like to create?"
          ]
        },

        g6_our_greener_world: {
          part1: [
            "Question 1. What do you do to help the environment?",
            "Question 2. Do you recycle at home?",
            "Question 3. What things do you reuse?",
            "Question 4. Who teaches you about protecting the environment?",
            "Question 5. What green activities do you enjoy?"
          ],
          part2: ["Question 6. Please tell me about ways to make the world greener."],
          part3: [
            "Question 7. Why is it important to protect the environment?",
            "Question 8. What can students do to save energy?",
            "Question 9. How can we reduce pollution?",
            "Question 10. What green habit would you like to start?"
          ]
        },

        g6_robots: {
          part1: [
            "Question 1. Have you ever seen a robot?",
            "Question 2. What can robots do?",
            "Question 3. What type of robot would you like to have?",
            "Question 4. How often do you use technology?",
            "Question 5. What do you want a robot to help you with?"
          ],
          part2: ["Question 6. Please tell me about robots in the future."],
          part3: [
            "Question 7. How can robots help people?",
            "Question 8. Will robots be important in the future?",
            "Question 9. What are the good things about robots?",
            "Question 10. What should students learn if they want to build robots?"
          ]
        }
      };

      /* ===== G·ª¢I √ù: 1 ƒêO·∫†N / CH·ª¶ ƒê·ªÄ ===== */
      const SUGGESTED_PARAGRAPHS_6 = {
        g6_my_new_school:
          "My new school is a lower secondary school in my hometown. It is not very big, but it is clean and beautiful. There are many classrooms with large windows, fans and new desks. In the school yard there are some trees, flowers and a small playground where we play at break time. I usually go to school by bike with my friends. My favourite teacher is my English teacher because she is kind, patient and always smiles. My favourite subject is English because I want to speak with foreigners in the future. At break time I often talk with my friends, play games or walk around the yard. I think wearing a school uniform is important because it makes students look tidy and equal. A good student should study hard, listen to teachers and help classmates. In the future I would like to have more trees and a bigger library in my school.",
        g6_my_house:
          "Sample 1 ‚Äì My house in a town:\n\nI live in a small but comfortable house with my family in a quiet street near the town centre. Our house has a living room, a kitchen, two bedrooms and a bathroom. In the living room there is a sofa, a small table and a TV where we sit together in the evening. My favourite room is my bedroom because I can study and relax there. I share the house with my parents and my younger brother. At home I usually do homework, read books, watch TV and sometimes play games with my brother. It is very important to keep the house clean so that everyone is healthy and happy. We sweep the floor, wash the dishes and put things in the right place. My dream town house would be a little bigger, with a small balcony and a study room full of books.\n\nSample 2 ‚Äì My house in the countryside:\n\nI live in a simple house in the countryside, in a small village with rice fields around. Our house has a tiled roof and a large yard in front where children can play and my family can dry rice or corn. Inside the house there is a living room, a kitchen and two or three bedrooms. My favourite place is the yard because I can ride my bike, play with my cousins and help my parents with outdoor work. I live with my grandparents, my parents and my brother, so the house is always busy and warm. At home I usually feed the chickens, water the vegetables and sweep the yard. Keeping the house and yard clean is important because there is a lot of dust from the road. In the future I would like to plant more trees and flowers around my countryside house to make it greener and more beautiful.",
        g6_my_friends:
          "I am lucky because I have some good friends at school. My best friend is the same age as me and we are in the same class. We first met in Grade 1 when we sat next to each other. We usually study together, play games at break time and talk about our hobbies. I like my friends because they are friendly, honest and funny. We often help one another with homework and share snacks. I see my friends every day at school and sometimes at the weekend. A good friend is someone who listens to you, keeps your secrets and stays with you when you are sad. I think it is not necessary to have many friends, but it is important to have some true friends. When my friends have a problem, I listen to them and try to give simple advice. School clubs, group projects and sports activities help students make new friends.",
        g6_my_neighbourhood:
          "Sample 1 ‚Äì My neighbourhood in a town:\n\nI live in a small neighbourhood on the edge of a town. It is not very crowded, and there are many trees along the streets. Near my house there is a market, a small park, a pharmacy and a grocery store. I often meet neighbours when I go to the shop or ride my bike around. People in my neighbourhood are friendly and helpful. I like my neighbourhood because it is safe and quiet. A good neighbourhood should be clean, have good roads and kind people. Students should help keep their neighbourhood clean by not throwing rubbish on the street, joining clean-up days and reminding others to protect the environment. To make the area safer, people can follow traffic rules, use lights at night and watch out for strangers. In the future I would like to see more green trees, a bigger playground and better sidewalks for children to walk and play.\n\nSample 2 ‚Äì My neighbourhood in the countryside:\n\nI live in a small village in the countryside. My neighbourhood is a quiet hamlet with simple houses and friendly neighbours. Around my home there are rice fields, gardens and small dirt roads instead of big streets. Near my house there is a village well, a small shop and a communal house where people meet on special days. I often see farmers working on the fields and children playing games in the yard. I like my neighbourhood because the air is fresh and people know each other very well. A good countryside neighbourhood should be clean, peaceful and safe for children. Students can help by keeping the lane in front of their house tidy, not throwing rubbish into the canal and joining village clean-up days. In the future I would like to have more trees along the village road and maybe a small playground for children in my hamlet.",
        g6_natural_wonders:
          "Viet Nam has many beautiful natural wonders that attract visitors from all over the world. One famous place is Ha Long Bay, with thousands of limestone islands rising from the blue sea. Another beautiful place is Phong Nha Cave with long caves and strange rock shapes. I have not visited many natural wonders yet, but I really want to go to Ha Long Bay with my family or close friends. When I visit beautiful places, I feel relaxed, happy and proud of my country. We should protect natural wonders because they are part of our national heritage. Too many tourists, rubbish and pollution can damage the environment. Students can help by not throwing trash, joining campaigns to protect nature and sharing photos of Viet Nam's beauty in a respectful way. In the future I would like to explore more natural wonders to learn about nature and take nice pictures.",
        g6_our_tet_holiday:
          "Tet is my favourite holiday in Viet Nam because it is a time for family and new beginnings. Before Tet, people clean the house, decorate it with flowers and buy new clothes. During Tet I usually help my parents prepare food and visit my relatives. We eat traditional dishes such as sticky rice cake, boiled chicken and pickled vegetables. I often visit my grandparents, aunts and uncles to wish them good health. The activities I enjoy most at Tet are receiving lucky money, watching fireworks and playing games with my cousins. Tet is very important in Viet Nam because families come together and people remember their ancestors. Children should follow customs such as greeting elders politely, speaking nicely and wearing clean clothes. To keep Tet traditions alive, we need to teach young people about the meaning of Tet and continue beautiful customs like family meals and visiting relatives.",
        g6_television:
          "I usually watch TV for about one or two hours a day, mostly in the evening after I finish my homework. My favourite TV programme is an educational show for children because I can learn new things in a fun way. I often watch TV with my family in the living room. From television I learn about the world, science, animals and other countries. Watching TV can be good for students if they choose the right programmes, such as news for children, science shows or English programmes. Students should avoid watching violent or scary films. We need to use TV time wisely by making a plan and not watching too long, so it does not affect our eyes and sleep. In the future television may be more modern, with better pictures and more interactive programmes, but I think reading books and doing outdoor activities will still be important.",
        g6_sports_games:
          "Sports and games are an important part of my life. I like playing football and badminton because they are fun and help me keep fit. I usually play sports two or three times a week with my classmates after school or at the weekend. Sometimes I also watch sports matches on TV with my father, especially football matches. My favourite game is football because I can run, pass the ball and work in a team. Sports are important for students because they make our bodies strong, reduce stress and teach us teamwork and fair play. Some sports that help us stay healthy are swimming, running and cycling. I think students should play sports every day, even for a short time. In the future I would like to try other sports such as basketball or table tennis to have more experiences and make new friends.",
        g6_cities_world:
          "I live in a small city in Viet Nam, but I also know some famous cities around the world such as London, Paris, Tokyo and New York from books and television. If I could choose one city to visit, I would like to go to Tokyo because it looks modern, clean and full of interesting technology. I would travel with my family so that we can enjoy the trip together. When visiting a city, I like walking around, trying local food, taking photos and visiting museums or parks. A beautiful city usually has clean streets, green parks, old and modern buildings and polite people. Cities can become cleaner if people use public transport, throw rubbish in the right place and plant more trees. Many people enjoy living in big cities because there are more schools, jobs and entertainment. In the future I hope to explore more cities to learn about different cultures.",
        g6_houses_future:
          "My house now is simple, with a few rooms and basic furniture, but it is warm and full of love. In the future I would like my house to be more modern and comfortable. I want it to have a bright living room, a study room with many books and maybe a small garden with flowers and vegetables. I would like my future house to be near a school or park and in a quiet area. I hope to live with my family so that we can support each other. In my future house I want some smart technology, for example lights that turn off automatically, a machine that cleans the floor and maybe a small robot that helps with housework. People want modern houses because they save time and make life easier. In the future houses may have solar panels, smart doors and better designs to protect the environment.",
        g6_our_greener_world:
          "I think everyone can do something to make the world greener. At home I try to turn off lights and fans when I do not use them, and I close the tap carefully to save water. My family sometimes recycles plastic bottles and paper, and we reuse old bags when we go to the market. I also keep my school desk clean and put rubbish into the bin. My teachers and parents teach me about protecting the environment and explain why it is important. Green activities I enjoy are planting trees, growing small plants in pots and joining clean-up days at school. Protecting the environment is important because we need clean air, water and land to live. Students can save energy by switching off electrical devices, walking or cycling for short distances and using both sides of paper. In the future I would like to start a habit of bringing my own bottle and reusable bag everywhere.",
        g6_robots:
          "I have seen robots in cartoons, on the Internet and sometimes in exhibitions. Robots can do many things such as cleaning the floor, cooking simple food, helping in factories and even playing with children. I would like to have a small robot that can help me do homework, remind me of my timetable and tidy my bedroom. I use technology every day when I study on the computer, use a smartphone or watch TV. In the future robots can help people by doing dangerous or boring jobs, like working in space or in deep water. Robots will probably be very important, but we still need humans to control them and make good decisions. The good things about robots are that they do not get tired and can work very exactly. Students who want to build robots should learn science, mathematics, programming and practice solving problems in a creative way."
      };

      /* ========== DOM ========== */
      const gradeSelect = document.getElementById("gradeSelect");
      const topicSelect = document.getElementById("topicSelect");
      const partSelect  = document.getElementById("partSelect");
      const questionList = document.getElementById("questionList");
      const questionTextarea = document.getElementById("question");
      const questionTextContainer = document.getElementById("questionTextContainer");
      const showTextBtn = document.getElementById("showTextBtn");
      const speakQuestionBtn = document.getElementById("speakQuestionBtn");
      const answerText = document.getElementById("answerText");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const sendBtn = document.getElementById("sendBtn");
      const suggestBtn = document.getElementById("suggestBtn");
      const suggestionsArea = document.getElementById("suggestionsArea");
      const resultArea = document.getElementById("resultArea");
      const clearBtn = document.getElementById("clearBtn");
      const statusEl = document.getElementById("status");
      const uploadProgress = document.getElementById("uploadProgress");
      const progressBar = document.getElementById("progressBar");
      const progressPercent = document.getElementById("progressPercent");
      const timerBox = document.getElementById("timerBox");
      const timerText = document.getElementById("timerText");
      const timerInline = document.getElementById("timerInline");
      const leaveHint = document.getElementById("leaveHint");

      const pendingBox = document.getElementById("pendingBox");
      const pendingInfo = document.getElementById("pendingInfo");
      const resendPendingBtn = document.getElementById("resendPendingBtn");
      const clearPendingBtn = document.getElementById("clearPendingBtn");

      // ========== state ==========
      let isRecording = false;
      let ignore_onend = false;

      // ======= unified audio recorder =======
      let recorderMode = "";          // "media" or "wav"
      let isFullRecordingStarted = false;
      let audioMimeType = "";
      let micStream = null;

      // B·∫Øt bu·ªôc ƒë·ªß 10 c√¢u
      let recordedFlags = new Array(TOTAL_QUESTIONS).fill(false);

      // ======= question state =======
      let questionTexts = new Array(TOTAL_QUESTIONS).fill("");
      let answers = new Array(TOTAL_QUESTIONS).fill("");
      let currentQuestionIndex = 0;
      let hasCompletedTopic = false;

      // ===================== API CALL =====================
      async function callScriptApiNoCors(action, payload) {
        const body = JSON.stringify({ action, ...payload });
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          redirect: "follow",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          keepalive: false, // IMPORTANT: reduce false "network" errors
          body
        });
        // no-cors: browser won't let us read server response => just confirm "sent request"
        return { ok: true, message: "ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV ƒë·ªÉ x√°c nh·∫≠n." };
      }

      async function submitWithRetry(payload) {
        let lastErr = null;
        for (let i = 0; i < 2; i++) {
          try {
            const r = await callScriptApiNoCors("submitAll", payload);
            if (r && r.ok) return { ok: true, r, channel: "no-cors" };
            lastErr = new Error((r && r.message) ? r.message : "Request failed");
          } catch (e) { lastErr = e; }
          await sleep(600 * (i + 1));
        }
        return { ok: false, error: lastErr };
      }

      function savePending(payload) {
        try {
          const obj = { payload, savedAt: new Date().toISOString() };
          localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
          showPendingBox();
        } catch(e) {}
      }

      function clearPending() {
        try { localStorage.removeItem(PENDING_KEY); } catch(e) {}
        pendingBox.style.display = "none";
      }

      function getPending() {
        try {
          const s = localStorage.getItem(PENDING_KEY);
          if (!s) return null;
          return JSON.parse(s);
        } catch(e) { return null; }
      }

      function showPendingBox() {
        const p = getPending();
        if (!p || !p.payload) { pendingBox.style.display = "none"; return; }
        pendingBox.style.display = "block";
        const dt = p.savedAt ? new Date(p.savedAt) : null;
        const when = dt ? dt.toLocaleString("vi-VN") : "(unknown time)";
        const payload = p.payload || {};
        const name = payload.studentName || (payload.meta && payload.meta.studentName) || "";
        const cls  = payload.studentClass || (payload.meta && payload.meta.studentClass) || "";
        const mode = payload.__pendingMode || "normal";
        pendingInfo.textContent = `H·ªç t√™n: ${name} | L·ªõp: ${cls} | L∆∞u l√∫c: ${when}` + (mode === "chunk" ? " | (C√≥ k√®m audio ƒë·ªÉ g·ª≠i l·∫°i)" : "");
      }

      async function resendPendingChunk(payload) {
        const audioKey = payload.audioKey;
        const mimeType = payload.mimeType || "audio/webm";
        const meta = payload.meta || {};
        if (!audioKey) throw new Error("Missing audioKey");
        const blob = await idbGetBlob(audioKey);
        if (!blob) throw new Error("Audio blob not found (IndexedDB)");
        resultArea.textContent = "ƒêang g·ª≠i l·∫°i audio ƒë√£ l∆∞u...";
        leaveHint.style.display = "block";
        await uploadAudioInChunksNoCors(blob, mimeType, meta);
        await idbDelBlob(audioKey);
        clearPending();
        resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i l·∫°i th√†nh c√¥ng (k√®m audio)!</span>';
      }

      resendPendingBtn.onclick = async () => {
        const p = getPending();
        if (!p || !p.payload) return;

        resultArea.textContent = "ƒêang g·ª≠i l·∫°i b√†i ƒë√£ l∆∞u...";
        resendPendingBtn.disabled = true;
        clearPendingBtn.disabled = true;

        try {
          if (p.payload.__pendingMode === "chunk") {
            await resendPendingChunk(p.payload);
          } else {
            const out = await submitWithRetry(p.payload);
            if (out.ok) {
              clearPending();
              resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i l·∫°i. Vui l√≤ng ki·ªÉm tra email GV.</span>';
            } else {
              resultArea.innerHTML = '<span class="status-error">Ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c. Vui l√≤ng th·ª≠ l·∫°i khi m·∫°ng ·ªïn ƒë·ªãnh.</span>';
            }
          }
        } catch (e) {
          resultArea.innerHTML = '<span class="status-error">Ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c. Vui l√≤ng th·ª≠ l·∫°i khi m·∫°ng ·ªïn ƒë·ªãnh.</span>';
        }

        resendPendingBtn.disabled = false;
        clearPendingBtn.disabled = false;
      };

      clearPendingBtn.onclick = () => {
        if (!confirm("X√≥a b√†i l∆∞u ch∆∞a g·ª≠i?")) return;
        const p = getPending();
        if (p && p.payload && p.payload.__pendingMode === "chunk" && p.payload.audioKey) {
          idbDelBlob(p.payload.audioKey).catch(()=>{});
        }
        clearPending();
      };

      showPendingBox();

      // ======= init selects =======
      GRADES.forEach((g) => {
        const opt = document.createElement("option");
        opt.value = g.id;
        opt.textContent = g.name;
        gradeSelect.appendChild(opt);
      });

      function updateTopics() {
        const g = GRADES.find((x) => x.id === gradeSelect.value);
        topicSelect.innerHTML = "";
        if (g) {
          g.topics.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t.id;
            opt.textContent = t.name + (t.vn ? " - " + t.vn : "");
            topicSelect.appendChild(opt);
          });
        }
      }

      function resetTopicState() {
        questionTexts = new Array(TOTAL_QUESTIONS).fill("");
        answers = new Array(TOTAL_QUESTIONS).fill("");
        currentQuestionIndex = 0;
        hasCompletedTopic = false;
        suggestBtn.disabled = true;
        suggestionsArea.textContent = "";
        answerText.value = "";
        sendBtn.disabled = false;
        statusEl.textContent = 'Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.';
        recordedFlags = new Array(TOTAL_QUESTIONS).fill(false);

        // reset timer for new topic/session
        timeLocked = false;
        recordDeadlineTs = null;
        if (recordTimer) { clearInterval(recordTimer); recordTimer = null; }
        timerText.textContent = "08:00";
        timerBox.style.display = "none";
        if (timerInline) {
          timerInline.textContent = "08:00";
          timerInline.style.display = "none";
        }

        speakQuestionBtn.disabled = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      function renderQuestions() {
        const tId = topicSelect.value;
        const data = GRADE_6_QUESTIONS[tId] ? GRADE_6_QUESTIONS[tId] : { part1: [], part2: [], part3: [] };

        const part = partSelect.value;
        const list = part === "part1" ? data.part1 : part === "part2" ? data.part2 : data.part3;

        questionList.innerHTML = "";
        if ("speechSynthesis" in window) window.speechSynthesis.cancel();

        list.forEach((q, idx) => {
          const div = document.createElement("div");
          div.className = "question-item";
          const qNum = part === "part1" ? idx + 1 : part === "part2" ? 6 : idx + 7;
          const qIndex = qNum - 1;
          questionTexts[qIndex] = q;

          div.dataset.qindex = qIndex.toString();
          div.innerHTML = '<span class="q-no">Q' + qNum + '.</span><span>C√¢u h·ªèi ' + qNum + " (Hidden)</span>";

          div.onclick = () => {
            document.querySelectorAll(".question-item").forEach((e) => e.classList.remove("active"));
            div.classList.add("active");

            currentQuestionIndex = qIndex;
            questionTextarea.value = q;
            questionTextContainer.style.display = "none";

            answerText.value = answers[qIndex] || "";

            sendBtn.disabled = false;

            if ("speechSynthesis" in window) window.speechSynthesis.cancel();
            isRecording = false;
            ignore_onend = true;

            startBtn.disabled = timeLocked ? true : false;
            stopBtn.disabled = true;
            statusEl.textContent = timeLocked ? "‚õî H·∫øt th·ªùi gian (8 ph√∫t cho t·ªïng 10 c√¢u)." : 'Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.';
          };

          questionList.appendChild(div);
        });

        if (questionList.firstChild) questionList.firstChild.click();
      }

      gradeSelect.onchange = () => { updateTopics(); resetTopicState(); renderQuestions(); };
      topicSelect.onchange = () => { resetTopicState(); renderQuestions(); };
      partSelect.onchange = renderQuestions;

      updateTopics();
      renderQuestions();

      // ======= Step 2 buttons =======
      showTextBtn.onclick = () => { questionTextContainer.style.display = "block"; };
      speakQuestionBtn.onclick = () => { speakText(questionTextarea.value); };

      // ===================== Start/Stop speaking =====================
      startBtn.onclick = async () => {
        if (timeLocked) {
          alert("H·∫øt th·ªùi gian (8 ph√∫t cho t·ªïng 10 c√¢u). B·∫°n kh√¥ng th·ªÉ tr·∫£ l·ªùi th√™m.");
          return;
        }
        if (getRemainingSeconds() <= 0) {
          lockByTimeUp();
          return;
        }

        // start countdown at FIRST "B·∫Øt ƒë·∫ßu n√≥i"
        startCountdownIfNeeded();

        try {
          await startFullRecordingIfNeeded();
          resumeFullRecording();

          recordedFlags[currentQuestionIndex] = true;

          if (recorderMode === "wav") {
            statusEl.textContent = "ƒêang ghi √¢m (WAV fallback ‚Äì iPhone/iPad OK). N√≥i to v√† r√µ.";
          } else {
            statusEl.textContent = "ƒêang ghi √¢m... N√≥i to v√† r√µ.";
          }
        } catch (err) {
          recordedFlags[currentQuestionIndex] = true;
          statusEl.textContent = "Kh√¥ng th·ªÉ kh·ªüi t·∫°o ghi √¢m. Vui l√≤ng ki·ªÉm tra quy·ªÅn Microphone.";
          return;
        }

        isRecording = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusEl.textContent = "ƒêang ghi √¢m... H√£y n√≥i c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.";
      };

      stopBtn.onclick = () => {
        if (timeLocked) return;

        isRecording = false;
        ignore_onend = true;

        pauseFullRecording();

        let currentAns = answerText.value.trim();
        if (currentAns) {
          if (!/[.!?]$/.test(currentAns)) currentAns += ".";
          answers[currentQuestionIndex] = currentAns;
          answerText.value = currentAns;
        }

        setTimeout(() => {
          const activeItem = document.querySelector(".question-item.active");

          if (activeItem && activeItem.nextElementSibling) {
            activeItem.nextElementSibling.click();
            const nextText = questionTextarea.value;
            if (nextText) {
              speakText(nextText);
              statusEl.textContent = "ƒê√£ chuy·ªÉn c√¢u & ƒêang ƒë·ªçc c√¢u h·ªèi...";
            }
          } else {
            const partOrder = ["part1", "part2", "part3"];
            const idx = partOrder.indexOf(partSelect.value);

            if (idx !== -1 && idx < partOrder.length - 1) {
              partSelect.value = partOrder[idx + 1];
              renderQuestions();
              const nextText = questionTextarea.value;
              if (nextText) {
                speakText(nextText);
                statusEl.textContent = "ƒê√£ chuy·ªÉn sang ph·∫ßn m·ªõi & ƒêang ƒë·ªçc c√¢u h·ªèi...";
              } else {
                statusEl.textContent = "ƒê√£ chuy·ªÉn sang ph·∫ßn m·ªõi.";
              }
            } else {
              statusEl.textContent = "ƒê√£ h·∫øt t·∫•t c·∫£ c√¢u h·ªèi c·ªßa ch·ªß ƒë·ªÅ n√†y.";
              hasCompletedTopic = true;
              suggestBtn.disabled = false;
            }
          }

          startBtn.disabled = timeLocked ? true : false;
          stopBtn.disabled = true;
        }, 1200);
      };

      clearBtn.onclick = () => {
        if (!confirm("B·∫°n mu·ªën x√≥a h·∫øt n·ªôi dung v·ª´a n√≥i ƒë·ªÉ l√†m l·∫°i?")) return;

        isRecording = false;
        ignore_onend = true;

        answerText.value = "";
        answers[currentQuestionIndex] = "";

        sendBtn.disabled = false;

        statusEl.textContent = "ƒê√£ x√≥a. Nh·∫•n B·∫Øt ƒë·∫ßu n√≥i ƒë·ªÉ l√†m l·∫°i.";
        startBtn.disabled = timeLocked ? true : false;
        stopBtn.disabled = true;

        hasCompletedTopic = false;
        suggestBtn.disabled = true;
        suggestionsArea.textContent = "";

        recordedFlags[currentQuestionIndex] = false;
      };

      // ===================== SEND (NO MP3, compatible Code.gs) =====================
      sendBtn.onclick = () => {
        let currentAns = answerText.value.trim();
        if (currentAns) {
          if (!/[.!?]$/.test(currentAns)) currentAns += ".";
          answers[currentQuestionIndex] = currentAns;
          answerText.value = currentAns;
        }

        if (!hasCompletedTopic) {
          alert("B·∫°n c·∫ßn ƒë·ªÉ ·ª©ng d·ª•ng ch·∫°y h·∫øt 10 c√¢u h·ªèi (c·∫£ 3 ph·∫ßn) r·ªìi m·ªõi n·ªôp b√†i cho gi√°o vi√™n.");
          return;
        }

        if (!allTenQuestionsRecorded()) {
          alert("B·∫°n ph·∫£i b·∫•m 'B·∫Øt ƒë·∫ßu n√≥i' v√† tr·∫£ l·ªùi ƒë·ªß 10 c√¢u (Q1‚ÜíQ10) th√¨ m·ªõi n·ªôp ƒë∆∞·ª£c b√†i.");
          return;
        }

        const n = document.getElementById("studentName").value;
        const c = document.getElementById("studentClass").value;
        const tOpt = document.querySelector("#topicSelect option:checked");
        const topicLabel = tOpt ? tOpt.text : "Topic";

        if (!n || !c) {
          alert("Thi·∫øu H·ªç t√™n ho·∫∑c L·ªõp.");
          return;
        }

        // Lu√¥n g·ª≠i transcript r·ªóng
        const fullTranscript = "";
        const questionSummary = `${topicLabel} ‚Äì 10-question speaking practice`;

        sendBtn.disabled = true;
        resultArea.textContent = "ƒêang x·ª≠ l√Ω audio...";
        pauseFullRecording();
        leaveHint.style.display = "block";

        const sendTranscriptOnly = async () => {
          resultArea.textContent = "ƒêang n·ªôp b√†i (kh√¥ng c√≥ audio)...";
          const payload = {
            studentName: n, studentClass: c, topicLabel,
            questionSummary, transcript: fullTranscript,
            mimeType: "", dataUrl: ""
          };
          const out = await submitWithRetry(payload);
          sendBtn.disabled = false;

          if (out.ok) {
            resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV.</span>';
          } else {
            savePending(payload);
            resultArea.innerHTML = '<span class="status-error">Tr√¨nh duy·ªát ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c vi·ªác n·ªôp b√†i. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u" v√† ki·ªÉm tra email GV.</span>';
          }
        };

        if (!isFullRecordingStarted) {
          sendTranscriptOnly();
          return;
        }

        stopFullRecording((blob) => {
          (async () => {
            try {
              if (!blob || !blob.size) {
                sendBtn.disabled = false;
                resultArea.innerHTML = '<span class="status-error">Kh√¥ng t·∫°o ƒë∆∞·ª£c file ghi √¢m. Vui l√≤ng th·ª≠ l·∫°i.</span>';
                return;
              }

              // IMPORTANT: Kh√¥ng MP3 ƒë·ªÉ gi·ªØ t∆∞∆°ng th√≠ch Code.gs (ƒë·ªÉ Code.gs t·ª± ƒë·∫∑t .webm/.wav)
              const finalBlob = blob;
              const mime = (finalBlob.type || audioMimeType || "audio/webm");
              const sizeMB = (finalBlob.size / (1024 * 1024)).toFixed(2);

              // 1) Blob nh·ªè: g·ª≠i dataUrl
              if (finalBlob.size <= SMALL_BLOB_MAX) {
                resultArea.textContent = `Audio ${sizeMB}MB: ƒëang chu·∫©n b·ªã g·ª≠i...`;

                const dataUrl = await new Promise((resolve) => { blobToDataUrl(finalBlob, resolve); });
                if (!dataUrl) {
                  sendBtn.disabled = false;
                  resultArea.innerHTML = '<span class="status-error">L·ªói chuy·ªÉn ƒë·ªïi audio. Vui l√≤ng th·ª≠ l·∫°i.</span>';
                  return;
                }

                let finalDataUrl = dataUrl;
                let finalMime = mime;
                if (finalDataUrl.length > MAX_DATAURL_CHARS) {
                  finalDataUrl = "";
                  finalMime = "";
                }

                const payload = {
                  studentName: n, studentClass: c, topicLabel,
                  questionSummary,
                  transcript: fullTranscript,
                  mimeType: finalMime,
                  dataUrl: finalDataUrl
                };

                // l∆∞u pending ƒë·ªÉ c√≥ th·ªÉ g·ª≠i l·∫°i n·∫øu browser b√°o l·ªói
                if (finalDataUrl) savePending(payload);

                resultArea.textContent = finalDataUrl
                  ? "ƒêang n·ªôp b√†i (audio + transcript)..."
                  : "Audio qu√° l·ªõn (base64). ƒêang n·ªôp b√†i (kh√¥ng k√®m audio)...";

                const out = await submitWithRetry(payload);
                sendBtn.disabled = false;

                if (out.ok) {
                  clearPending();
                  resultArea.innerHTML = finalDataUrl
                    ? '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV (s·∫Ω c√≥ link audio).</span>'
                    : '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu (kh√¥ng k√®m audio). Vui l√≤ng ki·ªÉm tra email GV.</span>';
                } else {
                  savePending(payload);
                  resultArea.innerHTML = '<span class="status-error">Tr√¨nh duy·ªát ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c vi·ªác n·ªôp b√†i. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u" v√† ki·ªÉm tra email GV.</span>';
                }
                return;
              }

              // 2) Blob l·ªõn: CHUNK upload + l∆∞u an to√†n ƒë·ªÉ resend
              resultArea.textContent = `Audio ${sizeMB}MB: ƒëang chia nh·ªè & upload...`;
              statusEl.textContent = 'ƒêang g·ª≠i b√†i... B·∫°n c√≥ th·ªÉ r·ªùi kh·ªèi trang trong khi qu√° tr√¨nh g·ª≠i b√†i ƒëang di·ªÖn ra.';

              const audioKey = `AUDIO_${Date.now()}_${Math.random().toString(16).slice(2)}`;
              try { await idbSetBlob(audioKey, finalBlob); } catch(e) {}

              const meta = {
                studentName: n,
                studentClass: c,
                topicLabel,
                questionSummary,
                transcript: fullTranscript
              };

              savePending({
                __pendingMode: "chunk",
                audioKey,
                mimeType: mime,
                meta,
                studentName: n,
                studentClass: c
              });

              try {
                await uploadAudioInChunksNoCors(finalBlob, mime, meta);
                sendBtn.disabled = false;
                await idbDelBlob(audioKey);
                clearPending();
                resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV (s·∫Ω c√≥ link audio).</span>';
              } catch (e) {
                sendBtn.disabled = false;
                resultArea.innerHTML = '<span class="status-error">Upload ch∆∞a ho√†n t·∫•t/kh√¥ng x√°c nh·∫≠n ƒë∆∞·ª£c. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u" v√† ki·ªÉm tra email GV.</span>';
              }
            } catch (e) {
              sendBtn.disabled = false;
              resultArea.innerHTML = '<span class="status-error">C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.</span>';
            }
          })();
        });
      };

      // g·ª£i √Ω
      suggestBtn.onclick = () => {
  if (!hasCompletedTopic) {
    alert("B·∫°n c·∫ßn ch·∫°y h·∫øt 10 c√¢u (t·ª´ c√¢u 1 ƒë·∫øn c√¢u 10) tr∆∞·ªõc khi xem g·ª£i √Ω ƒë·ªÉ tr√°nh ph·ª• thu·ªôc v√†o b√†i m·∫´u.");
    return;
  }

  const topicId = topicSelect.value;
  const bank = SUGGESTED_ANSWERS_6[topicId];

  if (!bank) {
    suggestionsArea.textContent = "Hi·ªán ch∆∞a c√≥ g·ª£i √Ω tr·∫£ l·ªùi cho ch·ªß ƒë·ªÅ n√†y.";
    return;
  }

  let out = "";
  for (let i = 1; i <= 10; i++) {
    const a = bank[i] || "";
    out += `Q${i}: ${a}\n\n`;
  }
  suggestionsArea.textContent = out.trim();
};
      
        const topicId = topicSelect.value;
        const text = SUGGESTED_PARAGRAPHS_6[topicId];
        suggestionsArea.textContent = text || "Hi·ªán ch∆∞a c√≥ g·ª£i √Ω tr·∫£ l·ªùi cho ch·ªß ƒë·ªÅ n√†y. Th·∫ßy c√¥ s·∫Ω c·∫≠p nh·∫≠t sau.";
      };

      // ======= beforeunload warning =======
      window.addEventListener("beforeunload", (e) => {
        const p = getPending();
        if (uploadInProgress || (p && p.payload)) {
          e.preventDefault();
          e.returnValue = "";
          return "";
        }
      });

      // init (kept)
      initSpeech();
    </script>
  </body>
</html>
