<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>New Tran English App - Grade 6 Listening Mode</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg-gradient: linear-gradient(135deg, #fce38a, #f38181);
        --card-bg: #ffffffcc;
        --primary: #ff6f61;
        --primary-dark: #e65b4f;
        --accent: #45b7d1;
        --accent-soft: #e0f7ff;
        --text-main: #333;
      }
      * { box-sizing: border-box; }
      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        margin: 0; min-height: 100vh;
        background: var(--bg-gradient); color: var(--text-main);
      }
      .page { max-width: 960px; margin: 0 auto; padding: 16px 12px 40px; }
      h1 { text-align: center; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.18); margin: 8px 0 4px; font-size: 26px; }
      .subtitle { text-align: center; color: #fff; font-size: 13px; margin-bottom: 10px; }
      .card { background: var(--card-bg); backdrop-filter: blur(6px); border-radius: 16px; padding: 14px 16px; margin-top: 12px; box-shadow: 0 6px 14px rgba(0,0,0,0.15); }
      .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
      .pill { padding: 2px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; background: var(--accent-soft); color: #0077a3; white-space: nowrap; }
      .label { font-weight: 600; margin: 6px 0 2px; font-size: 14px; }
      input, select, textarea {
        width: 100%; border-radius: 10px; border: 1px solid #ddd;
        padding: 7px 9px; margin: 2px 0 8px; font-size: 14px; font-family: inherit;
        outline: none; transition: border 0.15s, box-shadow 0.15s;
      }
      input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(69, 183, 209, 0.25); }
      textarea { resize: vertical; min-height: 60px; }
      textarea[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }

      button {
        border: none; border-radius: 999px; padding: 8px 16px; font-size: 14px; font-weight: 600;
        cursor: pointer; font-family: inherit; display: inline-flex; align-items: center; gap: 6px;
        transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      }
      button:active { transform: translateY(1px); box-shadow: none; }
      .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(230, 91, 79, 0.45); }
      .btn-primary:hover { background: var(--primary-dark); }
      .btn-secondary { background: #fff; color: var(--primary); border: 1px solid rgba(0,0,0,0.06); }
      .btn-secondary:disabled, .btn-primary:disabled { opacity: 0.65; cursor: default; box-shadow: none; }
      .btn-danger { background: #ff4444; color: white; box-shadow: 0 4px 10px rgba(255, 68, 68, 0.4); }
      .btn-danger:hover { background: #cc0000; }

      .small { font-size: 12px; color: #666; }
      .status { font-size: 13px; margin-top: 4px; font-weight: 500; }
      .status-ok { color: #1b8f3b; }
      .status-error { color: #c62828; }
      .flex-row { display: flex; gap: 8px; flex-wrap: wrap; }
      .flex-row > div { flex: 1 1 150px; }
      .question-list {
        margin-top: 6px; border-radius: 10px; background: #fff; border: 1px solid #eee;
        max-height: 210px; overflow-y: auto; padding: 6px 6px 4px;
      }
      .question-item { padding: 6px 8px; border-radius: 8px; margin-bottom: 4px; font-size: 13px; cursor: pointer; display: flex; gap: 6px; }
      .question-item span.q-no { font-weight: 700; color: var(--accent); min-width: 52px; }
      .question-item:hover { background: #f3f9ff; }
      .question-item.active { background: #e1f2ff; border-left: 3px solid var(--accent); }
      .badge-part { font-size: 11px; padding: 1px 8px; border-radius: 999px; background: rgba(255,255,255,0.9); color: #555; border: 1px dashed #ddd; }
      .footer { text-align: center; font-size: 11px; color: #fff; margin-top: 18px; opacity: 0.9; }

      .btn-speak { background: #4caf50; color: #fff; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }
      .btn-speak:hover { background: #43a047; }

      #questionTextContainer { display: none; animation: fadeIn 0.3s; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      .marquee { width: 100%; overflow: hidden; white-space: nowrap; box-sizing: border-box; background: rgba(255,255,255,0.18); padding: 6px 0; margin-bottom: 6px; border-radius: 8px; backdrop-filter: blur(3px); }
      .marquee span { display: inline-block; padding-left: 100%; font-weight: bold; color: #d50000; font-size: 16px; animation: marqueeAnim 14s linear infinite; }
      @keyframes marqueeAnim { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }

      #inapp-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 9999; color: white;
        display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
      }
      .arrow-up { font-size: 40px; margin-bottom: 10px; animation: bounce 1s infinite; position: absolute; top: 20px; right: 20px; }
      @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

      .mini-banner {
        border-radius: 12px; padding: 10px 12px; background: rgba(255,255,255,0.8);
        border: 1px solid rgba(0,0,0,0.06); margin-top: 10px;
      }

      /* Upload Progress */
      .upload-progress {
        display: none;
        margin-top: 12px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
        border: 1px solid #ddd;
      }
      .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 13px;
        font-weight: 500;
      }
      .progress-bar-container {
        width: 100%;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
      }
      .progress-bar {
        width: 0%;
        height: 100%;
        background: #4caf50;
        transition: width 0.3s ease;
      }

      /* Countdown timer (detail box) */
      .timer-box {
        display: none;
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.85);
        border: 1px solid rgba(0,0,0,0.08);
        font-size: 13px;
      }
      .timer-box strong { color: #c62828; }
      .timer-warn {
        margin-top: 6px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(255, 243, 224, 0.95);
        border-left: 4px solid #ff9800;
        font-size: 12px;
        color: #444;
        display: none;
      }

      /* BIG TIMER right next to Start button */
      .timer-inline{
        display:none;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(255,255,255,0.9);
        border: 2px solid rgba(198,40,40,0.25);
        font-weight: 900;
        font-size: 22px;
        letter-spacing: 1px;
        color: #c62828;
        line-height: 1;
        min-width: 92px;
        text-align: center;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>

  <body>
    <div id="inapp-overlay">
      <div class="arrow-up">‚Üó</div>
      <h3>‚ö†Ô∏è C·∫£nh b√°o tr√¨nh duy·ªát</h3>
      <p>B·∫°n ƒëang m·ªü link n√†y tr√™n Zalo/Facebook.</p>
      <p>Microphone s·∫Ω <strong>kh√¥ng ho·∫°t ƒë·ªông</strong> ·ªü ƒë√¢y.</p>
      <p style="background:#444; padding:10px; border-radius:8px; margin-top:15px;">
        Vui l√≤ng nh·∫•n v√†o d·∫•u <strong>3 ch·∫•m (...)</strong> ·ªü g√≥c tr√™n c√πng b√™n ph·∫£i v√† ch·ªçn
        <br><strong>"M·ªü b·∫±ng tr√¨nh duy·ªát" (Open in Browser)</strong>.
      </p>
    </div>

    <div class="marquee">
      <span>‚òÖ Mr. T√¢n Tr·∫ßn Ng·ªçc ‚Äì Xu√¢n Ph√∫ lower secondary school ‚òÖ</span>
    </div>

    <div class="page">
      <h1>New Tran English App</h1>
      <div class="subtitle">Luy·ªán n√≥i ti·∫øng Anh ‚Äì Grade 6 (Listening Mode)</div>

      <div id="pendingBox" class="mini-banner" style="display:none;">
        <div><strong>‚ö†Ô∏è C√≥ 1 b√†i ch∆∞a g·ª≠i xong (ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c)</strong></div>
        <div class="small" id="pendingInfo"></div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="resendPendingBtn" class="btn-primary" type="button">üì§ G·ª≠i l·∫°i b√†i v·ª´a l∆∞u</button>
          <button id="clearPendingBtn" class="btn-secondary" type="button">üßπ X√≥a b√†i l∆∞u</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 0</div>
          <div><strong>Th√¥ng tin h·ªçc sinh</strong></div>
        </div>
        <div class="flex-row">
          <div>
            <div class="label">H·ªç v√† t√™n:</div>
            <input id="studentName" placeholder="Nguy·ªÖn VƒÉn Nam" />
          </div>
          <div>
            <div class="label">L·ªõp:</div>
            <input id="studentClass" placeholder="6A" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 1</div>
          <div><strong>Ch·ªçn b√†i luy·ªán n√≥i</strong></div>
        </div>
        <div class="flex-row">
          <div>
            <div class="label">Kh·ªëi l·ªõp:</div>
            <select id="gradeSelect"></select>
          </div>
          <div>
            <div class="label">Ch·ªß ƒë·ªÅ:</div>
            <select id="topicSelect"></select>
          </div>
        </div>
        <div class="flex-row">
          <div>
            <div class="label">Ph·∫ßn:</div>
            <select id="partSelect">
              <option value="part1">Part I. Answer personal questions</option>
              <option value="part2">Part II. Talk about the topic</option>
              <option value="part3">Part III. Answer questions about topic</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end;">
            <span class="badge-part" id="partNote"></span>
          </div>
        </div>
        <div class="label">Danh s√°ch c√¢u h·ªèi (B·∫•m v√†o ƒë·ªÉ ch·ªçn):</div>
        <div class="question-list" id="questionList"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 2</div>
          <div><strong>Nghe & Hi·ªÉu c√¢u h·ªèi</strong></div>
        </div>

        <div class="flex-row" style="align-items: center; margin-bottom: 10px;">
          <button id="speakQuestionBtn" class="btn-speak" type="button">üîä Nghe c√¢u h·ªèi (Listen)</button>
          <button id="showTextBtn" class="btn-secondary" type="button">üëÅÔ∏è Kh√¥ng nghe ƒë∆∞·ª£c? Hi·ªán vƒÉn b·∫£n</button>
        </div>

        <div id="questionTextContainer">
          <div class="label">N·ªôi dung c√¢u h·ªèi:</div>
          <textarea id="question" rows="3" readonly style="background:#f9f9f9; color:#555;"></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="pill">B∆∞·ªõc 3</div>
          <div><strong>Tr·∫£ l·ªùi & G·ª≠i</strong></div>
        </div>

        <div class="flex-row" style="align-items:center;margin-bottom:4px;">
          <button id="startBtn" class="btn-primary" type="button">üéô B·∫Øt ƒë·∫ßu n√≥i</button>

          <!-- BIG TIMER right next to Start -->
          <div id="timerInline" class="timer-inline" aria-live="polite">08:00</div>

          <button id="stopBtn" class="btn-secondary" type="button" disabled>‚èπ D·ª´ng & Qua c√¢u ti·∫øp theo</button>
        </div>

        <div id="status" class="status">Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.</div>

        <div id="timerBox" class="timer-box">
          ‚è≥ Th·ªùi gian c√≤n l·∫°i (t·ªïng 10 c√¢u): <strong id="timerText">08:00</strong>
        </div>
        <div id="leaveHint" class="timer-warn">
          Khi b·∫°n b·∫•m <strong>N·ªôp b√†i</strong>, h·ªá th·ªëng s·∫Ω g·ª≠i audio l√™n Drive c·ªßa gi√°o vi√™n. B·∫°n c√≥ th·ªÉ r·ªùi trang trong khi qu√° tr√¨nh g·ª≠i ƒëang di·ªÖn ra; b√†i s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°m ƒë·ªÉ g·ª≠i l·∫°i n·∫øu c√≥ l·ªói k·∫øt n·ªëi/gi·ªõi h·∫°n tr√¨nh duy·ªát.
        </div>

        <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #4caf50;">
          <strong>üì¢ L∆∞u √Ω:</strong> ·ª®ng d·ª•ng ch·ªâ y√™u c·∫ßu <strong>n√≥i (ghi √¢m)</strong>. Kh√¥ng c·∫ßn nh·∫≠p vƒÉn b·∫£n.
        </div>

        <!-- Transcript ·∫©n -->
        <div style="display: none;">
          <div class="label">Transcript (HS n√≥i):</div>
          <textarea
            id="answerText"
            rows="5"
            readonly
            placeholder="VƒÉn b·∫£n s·∫Ω t·ª± ƒë·ªông hi·ªán khi b·∫°n n√≥i... (Kh√¥ng th·ªÉ t·ª± g√µ)"
            style="background-color:#f0f8ff;"
          ></textarea>

          <div class="flex-row" style="align-items:center; gap:8px; margin-top: 5px;">
            <button id="clearBtn" class="btn-danger" type="button">üóë X√≥a c√¢u tr·∫£ l·ªùi n√†y</button>
          </div>
        </div>

        <br />

        <div class="flex-row" style="align-items:center; gap:8px;">
          <button id="sendBtn" class="btn-primary" type="button">üì© N·ªôp b√†i cho GV</button>
          <button id="suggestBtn" class="btn-secondary" type="button" disabled>üí° Xem g·ª£i √Ω tr·∫£ l·ªùi</button>
        </div>

        <div id="uploadProgress" class="upload-progress">
          <div class="progress-header">
            <span>ƒêang t·∫£i l√™n...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>K·∫øt qu·∫£ g·ª≠i</h2>
        <div id="resultArea" class="small">Ch∆∞a g·ª≠i.</div>
      </div>

      <div class="card">
        <h2>G·ª£i √Ω tr·∫£ l·ªùi / Suggested Answer</h2>
        <div id="suggestionsArea" class="small" style="white-space: pre-line;"></div>
      </div>

      <div class="footer">¬© New Tran English App ‚Äì T√¢n Tr·∫ßn Ng·ªçc &amp; Google Apps Script</div>
    </div>

    <script>
      // ===================== APPS SCRIPT URL (FINAL) =====================
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZ48S-PVLSK-ZpXvbITFx6MTL_uG6dvwCqwyyzuzqonZGqudpFwaohsSQkF2QYBxuM/exec";
      // ===================================================================

      const TOTAL_QUESTIONS = 10;

      // ======= l∆∞u b√†i khi g·ª≠i l·ªói =======
      const PENDING_KEY = "NEWTRAN_PENDING_SUBMISSION_V1";
      // ======= l∆∞u audio blob (IndexedDB) =======
      const PENDING_AUDIO_DB = "NEWTRAN_PENDING_AUDIO_DB_V1";
      const PENDING_AUDIO_STORE = "blobs";

      // ======= ch·ªëng qu√° dung l∆∞·ª£ng (base64) =======
      const MAX_DATAURL_CHARS = 28_000_000;
      const SMALL_BLOB_MAX = 4 * 1024 * 1024; // <= 4MB: g·ª≠i dataUrl; >4MB: d√πng chunk upload

      // ===== Countdown 8 minutes TOTAL for all 10 questions =====
      const RECORD_LIMIT_SEC = 8 * 60;
      let recordDeadlineTs = null;
      let recordTimer = null;
      let timeLocked = false;

      // ===== Upload in progress flag (warn) =====
      let uploadInProgress = false;

      // ========== helpers ==========
      function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
      function formatMMSS(sec){
        sec = Math.max(0, Math.floor(sec));
        const m = Math.floor(sec/60);
        const s = sec % 60;
        return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
      }
      function getRemainingSeconds(){
        if (!recordDeadlineTs) return RECORD_LIMIT_SEC;
        return Math.max(0, Math.floor((recordDeadlineTs - Date.now()) / 1000));
      }
      function lockByTimeUp(){
        timeLocked = true;
        try { pauseFullRecording(); } catch(e){}
        isRecording = false;
        startBtn.disabled = true;
        stopBtn.disabled = true;
        speakQuestionBtn.disabled = true;
        statusEl.textContent = "‚õî H·∫øt th·ªùi gian (8 ph√∫t cho t·ªïng 10 c√¢u). B·∫°n kh√¥ng th·ªÉ tr·∫£ l·ªùi th√™m.";
        alert("H·∫øt th·ªùi gian l√†m b√†i (8 ph√∫t cho t·ªïng 10 c√¢u). B·∫°n kh√¥ng th·ªÉ tr·∫£ l·ªùi th√™m.");
      }
      function tickTimer(){
        const remain = getRemainingSeconds();
        const txt = formatMMSS(remain);
        timerText.textContent = txt;

        if (timerInline) {
          timerInline.textContent = txt;
          timerInline.style.display = "inline-flex";
        }

        timerBox.style.display = "block";

        if (remain <= 0) {
          clearInterval(recordTimer);
          recordTimer = null;
          if (!timeLocked) lockByTimeUp();
        }
      }
      function startCountdownIfNeeded(){
        if (timeLocked) return;
        if (!recordDeadlineTs) {
          recordDeadlineTs = Date.now() + RECORD_LIMIT_SEC * 1000;
          timerBox.style.display = "block";
          tickTimer();
          if (!recordTimer) recordTimer = setInterval(tickTimer, 250);
        }
      }

      function pickSupportedMime() {
        const candidates = ["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"];
        if (!window.MediaRecorder) return "";
        for (const t of candidates) {
          try { if (MediaRecorder.isTypeSupported(t)) return t; } catch (e) {}
        }
        return "";
      }

      async function ensureMicStream() {
        if (micStream) return micStream;
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return micStream;
      }

      function allTenQuestionsRecorded() {
        for (let i = 0; i < TOTAL_QUESTIONS; i++) if (!recordedFlags[i]) return false;
        return true;
      }

      function blobToDataUrl(blob, cb) {
        const fr = new FileReader();
        fr.onload = () => cb(fr.result);
        fr.onerror = () => cb(null);
        fr.readAsDataURL(blob);
      }

      // ===================== IndexedDB helpers (store audio safely) =====================
      function openPendingAudioDb() {
        return new Promise((resolve, reject) => {
          try {
            const req = indexedDB.open(PENDING_AUDIO_DB, 1);
            req.onupgradeneeded = () => {
              const db = req.result;
              if (!db.objectStoreNames.contains(PENDING_AUDIO_STORE)) {
                db.createObjectStore(PENDING_AUDIO_STORE);
              }
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
          } catch (e) { reject(e); }
        });
      }

      async function idbSetBlob(key, blob) {
        const db = await openPendingAudioDb();
        return new Promise((resolve, reject) => {
          try {
            const tx = db.transaction(PENDING_AUDIO_STORE, "readwrite");
            tx.objectStore(PENDING_AUDIO_STORE).put(blob, key);
            tx.oncomplete = () => { try { db.close(); } catch(e){} resolve(true); };
            tx.onerror = () => { try { db.close(); } catch(e){} reject(tx.error); };
          } catch (e) {
            try { db.close(); } catch(_) {}
            reject(e);
          }
        });
      }

      async function idbGetBlob(key) {
        const db = await openPendingAudioDb();
        return new Promise((resolve, reject) => {
          try {
            const tx = db.transaction(PENDING_AUDIO_STORE, "readonly");
            const req = tx.objectStore(PENDING_AUDIO_STORE).get(key);
            req.onsuccess = () => { try { db.close(); } catch(e){} resolve(req.result || null); };
            req.onerror = () => { try { db.close(); } catch(e){} reject(req.error); };
          } catch (e) {
            try { db.close(); } catch(_) {}
            reject(e);
          }
        });
      }

      async function idbDelBlob(key) {
        const db = await openPendingAudioDb();
        return new Promise((resolve) => {
          try {
            const tx = db.transaction(PENDING_AUDIO_STORE, "readwrite");
            tx.objectStore(PENDING_AUDIO_STORE).delete(key);
            tx.oncomplete = () => { try { db.close(); } catch(e){} resolve(true); };
            tx.onerror = () => { try { db.close(); } catch(e){} resolve(false); };
          } catch (e) {
            try { db.close(); } catch(_) {}
            resolve(false);
          }
        });
      }

      // ===================== CHUNK UPLOAD (NO-CORS) =====================
      function uint8ToBase64(u8) {
        let binary = "";
        const chunk = 0x8000;
        for (let i = 0; i < u8.length; i += chunk) {
          binary += String.fromCharCode.apply(null, u8.subarray(i, i + chunk));
        }
        return btoa(binary);
      }

      async function uploadAudioInChunksNoCors(blob, mimeType, meta) {
        const uploadId = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const bytes = new Uint8Array(await blob.arrayBuffer());

        const ua = navigator.userAgent || "";
        const isIOS = /iPad|iPhone|iPod/.test(ua);
        const chunkBytes = isIOS ? (200 * 1024) : (512 * 1024);
        const total = Math.ceil(bytes.length / chunkBytes);

        uploadProgress.style.display = "block";
        progressBar.style.width = "0%";
        progressPercent.textContent = "0%";
        uploadInProgress = true;

        const uploadChunkWithRetry = async (idx, b64, retries = 3) => {
          for (let attempt = 0; attempt < retries; attempt++) {
            try {
              await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                keepalive: false,
                body: JSON.stringify({
                  action: "uploadChunk",
                  uploadId,
                  idx,
                  total,
                  mimeType,
                  b64
                })
              });
              return true;
            } catch (err) {
              if (attempt < retries - 1) await sleep(400 * (attempt + 1));
            }
          }
          return false;
        };

        for (let idx = 0; idx < total; idx++) {
          const start = idx * chunkBytes;
          const end = Math.min(start + chunkBytes, bytes.length);
          const part = bytes.subarray(start, end);
          const b64 = uint8ToBase64(part);

          const ok = await uploadChunkWithRetry(idx, b64);
          if (!ok) {
            uploadInProgress = false;
            throw new Error(`Failed to upload chunk ${idx + 1}/${total}`);
          }

          const percent = Math.round(((idx + 1) / total) * 100);
          progressBar.style.width = `${percent}%`;
          progressPercent.textContent = `${percent}%`;
          await sleep(80);
        }

        const finalizeWithRetry = async (retries = 3) => {
          for (let attempt = 0; attempt < retries; attempt++) {
            try {
              await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                keepalive: false,
                body: JSON.stringify({
                  action: "finalizeUpload",
                  uploadId,
                  total,
                  mimeType,
                  ...meta
                })
              });
              return { ok: true, uploadId, total };
            } catch (err) {
              if (attempt < retries - 1) await sleep(800 * (attempt + 1));
            }
          }
          throw new Error("Failed to finalize upload after all retries");
        };

        const result = await finalizeWithRetry();
        uploadInProgress = false;

        setTimeout(() => { uploadProgress.style.display = "none"; }, 800);
        return result;
      }

      // ===================== WAV FALLBACK (WebAudio) =====================
      const WAV_TARGET_RATE = 16000;
      let wavCtx = null;
      let wavSource = null;
      let wavProcessor = null;
      let wavGain0 = null;
      let wavPaused = true;
      let wavBuffers = [];
      let wavInputRate = 48000;

      function downsampleBuffer(inputFloat32, inRate, outRate) {
        if (outRate === inRate) return inputFloat32;
        if (outRate > inRate) return inputFloat32;
        const ratio = inRate / outRate;
        const newLen = Math.round(inputFloat32.length / ratio);
        const result = new Float32Array(newLen);
        let offsetResult = 0;
        let offsetBuffer = 0;
        while (offsetResult < result.length) {
          const nextOffsetBuffer = Math.round((offsetResult + 1) * ratio);
          let accum = 0, count = 0;
          for (let i = offsetBuffer; i < nextOffsetBuffer && i < inputFloat32.length; i++) {
            accum += inputFloat32[i];
            count++;
          }
          result[offsetResult] = count ? (accum / count) : 0;
          offsetResult++;
          offsetBuffer = nextOffsetBuffer;
        }
        return result;
      }

      function floatTo16BitPCM(float32Array) {
        const out = new Int16Array(float32Array.length);
        for (let i = 0; i < float32Array.length; i++) {
          let s = Math.max(-1, Math.min(1, float32Array[i]));
          out[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return out;
      }

      function encodeWav(int16Data, sampleRate) {
        const buffer = new ArrayBuffer(44 + int16Data.length * 2);
        const view = new DataView(buffer);
        function writeString(offset, str){
          for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
        }
        const numChannels = 1;
        const bitsPerSample = 16;
        const byteRate = sampleRate * numChannels * bitsPerSample / 8;
        const blockAlign = numChannels * bitsPerSample / 8;
        const dataSize = int16Data.length * 2;

        writeString(0, "RIFF");
        view.setUint32(4, 36 + dataSize, true);
        writeString(8, "WAVE");
        writeString(12, "fmt ");
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);
        writeString(36, "data");
        view.setUint32(40, dataSize, true);

        let offset = 44;
        for (let i = 0; i < int16Data.length; i++, offset += 2) {
          view.setInt16(offset, int16Data[i], true);
        }
        return new Blob([buffer], { type: "audio/wav" });
      }

      async function startWavRecordingIfNeeded() {
        if (isFullRecordingStarted && recorderMode === "wav") return;
        await ensureMicStream();
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) throw new Error("WebAudio not supported");
        wavCtx = new AudioCtx({ latencyHint: "interactive" });
        try { await wavCtx.resume(); } catch(e){}

        wavInputRate = wavCtx.sampleRate || 48000;
        wavBuffers = [];
        wavPaused = true;

        wavSource = wavCtx.createMediaStreamSource(micStream);
        const bufferSize = 4096;
        wavProcessor = wavCtx.createScriptProcessor(bufferSize, 1, 1);

        wavGain0 = wavCtx.createGain();
        wavGain0.gain.value = 0;

        wavProcessor.onaudioprocess = (e) => {
          if (wavPaused) return;
          try {
            const input = e.inputBuffer.getChannelData(0);
            const down = downsampleBuffer(input, wavInputRate, WAV_TARGET_RATE);
            const pcm16 = floatTo16BitPCM(down);
            wavBuffers.push(pcm16);
          } catch(err) {}
        };

        wavSource.connect(wavProcessor);
        wavProcessor.connect(wavGain0);
        wavGain0.connect(wavCtx.destination);

        recorderMode = "wav";
        audioMimeType = "audio/wav";
        isFullRecordingStarted = true;
      }

      function stopWavRecording(cb) {
        try { wavPaused = true; } catch(e){}
        try { if (wavProcessor) wavProcessor.disconnect(); } catch(e){}
        try { if (wavSource) wavSource.disconnect(); } catch(e){}
        try { if (wavGain0) wavGain0.disconnect(); } catch(e){}

        const chunks = wavBuffers || [];
        let totalLen = 0;
        for (const a of chunks) totalLen += a.length;

        const merged = new Int16Array(totalLen);
        let off = 0;
        for (const a of chunks) { merged.set(a, off); off += a.length; }

        const blob = encodeWav(merged, WAV_TARGET_RATE);

        const ctxToClose = wavCtx;
        wavCtx = null; wavSource = null; wavProcessor = null; wavGain0 = null;
        wavBuffers = [];
        if (ctxToClose) { try { ctxToClose.close(); } catch(e) {} }

        cb && cb(blob);
      }

      // =================== MediaRecorder path ===================
      let mediaRecorder = null;
      let audioChunks = [];
      let fullAudioBlob = null;

      async function startMediaRecordingIfNeeded() {
        if (isFullRecordingStarted && recorderMode === "media" && mediaRecorder) return;
        if (!window.MediaRecorder) throw new Error("MediaRecorder not supported");
        await ensureMicStream();

        audioMimeType = pickSupportedMime() || "";
        audioChunks = [];
        fullAudioBlob = null;

        mediaRecorder = new MediaRecorder(
          micStream,
          audioMimeType ? { mimeType: audioMimeType } : undefined
        );

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          try { fullAudioBlob = new Blob(audioChunks, { type: (audioMimeType || "audio/webm") }); } catch (e) {}
        };

        try { mediaRecorder.start(1000); } catch(e) { mediaRecorder.start(); }

        recorderMode = "media";
        isFullRecordingStarted = true;
      }

      // ========= unified control =========
      async function startFullRecordingIfNeeded() {
        try { await startMediaRecordingIfNeeded(); }
        catch (e) { await startWavRecordingIfNeeded(); }
      }

      function pauseFullRecording() {
        if (!isFullRecordingStarted) return;
        if (recorderMode === "media" && mediaRecorder) {
          if (mediaRecorder.state === "recording") { try { mediaRecorder.pause(); } catch(e){} }
        } else if (recorderMode === "wav") {
          wavPaused = true;
        }
      }

      function resumeFullRecording() {
        if (!isFullRecordingStarted) return;
        if (recorderMode === "media" && mediaRecorder) {
          if (mediaRecorder.state === "paused") { try { mediaRecorder.resume(); } catch(e){} }
        } else if (recorderMode === "wav") {
          wavPaused = false;
        }
      }

      function stopFullRecording(cb) {
        if (!isFullRecordingStarted) { cb && cb(null); return; }
        if (recorderMode === "media" && mediaRecorder) {
          try { mediaRecorder.requestData(); } catch(e){}
          const prevOnStop = mediaRecorder.onstop;
          mediaRecorder.onstop = () => {
            try { fullAudioBlob = new Blob(audioChunks, { type: (audioMimeType || "audio/webm") }); } catch (e) {}
            mediaRecorder.onstop = prevOnStop;
            cb && cb(fullAudioBlob);
          };
          try { mediaRecorder.stop(); } catch (e) { cb && cb(null); }
        } else if (recorderMode === "wav") {
          stopWavRecording(cb);
        } else {
          cb && cb(null);
        }
      }

      // ========= SpeechRecognition (T·∫ÆT) =========
      let recognition = null;
      function initSpeech() { recognition = null; }

      // ========= iOS/Safari TTS English voice fix =========
      let englishVoice = null;
      let pendingSpeakText = null;

      function selectEnglishVoice() {
        if (!("speechSynthesis" in window)) return null;
        const voices = window.speechSynthesis.getVoices();
        if (!voices || !voices.length) return null;

        const preferredNames = ["Samantha", "Karen", "Daniel", "Moira", "Serena", "Martha"];

        let v =
          voices.find(v => preferredNames.includes(v.name)) ||
          voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-us")) ||
          voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-gb")) ||
          voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en"));

        englishVoice = v || null;
        return englishVoice;
      }

      if ("speechSynthesis" in window) {
        window.speechSynthesis.onvoiceschanged = function () {
          const hadPending = !!pendingSpeakText;
          selectEnglishVoice();
          if (englishVoice && hadPending) {
            const text = pendingSpeakText;
            pendingSpeakText = null;
            speakText(text);
          }
        };
      }

      function speakText(text) {
        if (!("speechSynthesis" in window)) return;

        pauseFullRecording();
        window.speechSynthesis.cancel();

        if (!englishVoice) {
          const v = selectEnglishVoice();
          if (!v) {
            pendingSpeakText = text;
            window.speechSynthesis.getVoices();
            return;
          }
        }

        const numberWords = {
          "0": "zero", "1": "one", "2": "two", "3": "three", "4": "four",
          "5": "five", "6": "six", "7": "seven", "8": "eight", "9": "nine", "10": "ten"
        };
        const processedText = text.replace(/Question\s+(\d+)/gi, (match, num) => {
          const w = numberWords[num];
          return w ? "Question " + w : match;
        });

        setTimeout(() => {
          const langCode = englishVoice && englishVoice.lang ? englishVoice.lang : "en-US";
          const u = new SpeechSynthesisUtterance(processedText);
          u.lang = langCode;
          u.rate = 0.9;
          if (englishVoice) u.voice = englishVoice;
          window.speechSynthesis.speak(u);

          setTimeout(() => { resumeFullRecording(); }, 100);
        }, 50);
      }

      // ======= in-app block =======
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isInApp = ua.indexOf("FBAN") > -1 || ua.indexOf("FBAV") > -1 || ua.indexOf("Zalo") > -1;
      if (isInApp) document.getElementById("inapp-overlay").style.display = "flex";

      // ================== D·ªÆ LI·ªÜU KH·ªêI 6 ==================
      const GRADES = [
        {
          id: "6",
          name: "Grade 6",
          topics: [
            { id: "g6_my_new_school",      name: "My New School",               vn: "Ng√¥i tr∆∞·ªùng m·ªõi c·ªßa em" },
            { id: "g6_my_house",           name: "My House",                    vn: "Ng√¥i nh√† c·ªßa em" },
            { id: "g6_my_friends",         name: "My Friends",                  vn: "Nh·ªØng ng∆∞·ªùi b·∫°n c·ªßa em" },
            { id: "g6_my_neighbourhood",   name: "My Neighbourhood",            vn: "Khu d√¢n c∆∞ c·ªßa em" },
            { id: "g6_natural_wonders",    name: "Natural Wonders of Viet Nam", vn: "C√°c k·ª≥ quan thi√™n nhi√™n c·ªßa Vi·ªát Nam" },
            { id: "g6_our_tet_holiday",    name: "Our Tet Holiday",             vn: "K·ª≥ ngh·ªâ T·∫øt c·ªßa ch√∫ng t√¥i" },
            { id: "g6_television",         name: "Television",                  vn: "Truy·ªÅn h√¨nh" },
            { id: "g6_sports_games",       name: "Sports and Games",            vn: "Th·ªÉ thao v√† tr√≤ ch∆°i" },
            { id: "g6_cities_world",       name: "Cities of the World",         vn: "C√°c th√†nh ph·ªë tr√™n th·∫ø gi·ªõi" },
            { id: "g6_houses_future",      name: "Our Houses in the Future",    vn: "Ng√¥i nh√† t∆∞∆°ng lai c·ªßa ch√∫ng ta" },
            { id: "g6_our_greener_world",  name: "Our Greener World",           vn: "Th·∫ø gi·ªõi xanh h∆°n c·ªßa ch√∫ng ta" },
            { id: "g6_robots",             name: "Robots",                      vn: "Ng∆∞·ªùi m√°y / R√¥-b·ªët" }
          ]
        }
      ];

      const GRADE_6_QUESTIONS = {
        g6_my_new_school: {
          part1: [
            "Question 1. What's the name of your school?",
            "Question 2. Where is your school?",
            "Question 3. Who is your favorite teacher?",
            "Question 4. What subject do you like the most?",
            "Question 5. How do you go to school every day?"
          ],
          part2: ["Question 6. Please tell me about your new school."],
          part3: [
            "Question 7. What do you do at break time?",
            "Question 8. Do you think wearing a school uniform is important?",
            "Question 9. What makes a good student?",
            "Question 10. What would you like to change in your school?"
          ]
        },
        g6_my_house: {
          part1: [
            "Question 1. Where do you live?",
            "Question 2. How many rooms are there in your house?",
            "Question 3. Which room do you like the most?",
            "Question 4. Who do you live with?",
            "Question 5. What do you usually do at home?"
          ],
          part2: ["Question 6. Please tell me about your house."],
          part3: [
            "Question 7. Why is it important to keep your house clean?",
            "Question 8. Do you prefer living in a house or an apartment?",
            "Question 9. What would your dream house be like?",
            "Question 10. How do you help your family at home?"
          ]
        },
        g6_my_friends: {
          part1: [
            "Question 1. Who is your best friend?",
            "Question 2. How did you meet your best friend?",
            "Question 3. What do you and your friends usually do together?",
            "Question 4. What do you like about your friends?",
            "Question 5. How often do you see your friends?"
          ],
          part2: ["Question 6. Please tell me about your friends."],
          part3: [
            "Question 7. What makes a good friend?",
            "Question 8. Do you think it is important to have many friends?",
            "Question 9. How do you help your friends when they have a problem?",
            "Question 10. What activities help students make new friends?"
          ]
        },
        g6_my_neighbourhood: {
          part1: [
            "Question 1. Do you live in the countryside or the city?",
            "Question 2. What is your neighbourhood like?",
            "Question 3. What places are near your house?",
            "Question 4. Who do you often meet in your neighbourhood?",
            "Question 5. What do you like most about your neighbourhood?"
          ],
          part2: ["Question 6. Please tell me about your neighbourhood."],
          part3: [
            "Question 7. What makes a neighbourhood a good place to live?",
            "Question 8. Should students help keep their neighbourhood clean?",
            "Question 9. How can people make a neighbourhood safer?",
            "Question 10. What changes would you like to see in your neighbourhood?"
          ]
        },
        g6_natural_wonders: {
          part1: [
            "Question 1. Have you ever visited a natural wonder?",
            "Question 2. What natural wonder in Viet Nam do you know?",
            "Question 3. Which natural place would you like to visit?",
            "Question 4. Who would you go with to visit a natural wonder?",
            "Question 5. How do you feel when visiting beautiful places?"
          ],
          part2: ["Question 6. Please tell me about a natural wonder in Viet Nam."],
          part3: [
            "Question 7. Why should we protect natural wonders?",
            "Question 8. How can tourism affect natural places?",
            "Question 9. What can students do to promote Viet Nam's natural wonders?",
            "Question 10. What natural wonder would you like to explore in the future?"
          ]
        },
        g6_our_tet_holiday: {
          part1: [
            "Question 1. What do you usually do during Tet?",
            "Question 2. What food do you eat at Tet?",
            "Question 3. Who do you visit during Tet?",
            "Question 4. What activities do you enjoy most at Tet?",
            "Question 5. What do you like getting at Tet?"
          ],
          part2: ["Question 6. Please tell me about your Tet holiday."],
          part3: [
            "Question 7. Why is Tet important in Viet Nam?",
            "Question 8. How do people prepare for Tet?",
            "Question 9. What customs should children follow at Tet?",
            "Question 10. How can we keep Tet traditions alive?"
          ]
        },
        g6_television: {
          part1: [
            "Question 1. How often do you watch TV?",
            "Question 2. What is your favorite TV programme?",
            "Question 3. Who do you usually watch TV with?",
            "Question 4. How many hours a day do you watch TV?",
            "Question 5. What do you learn from TV?"
          ],
          part2: ["Question 6. Please tell me about your TV habits."],
          part3: [
            "Question 7. Is watching TV good for students? Why?",
            "Question 8. What kinds of programmes should students watch?",
            "Question 9. How can we use TV time wisely?",
            "Question 10. Do you think TV will change in the future?"
          ]
        },
        g6_sports_games: {
          part1: [
            "Question 1. What sports do you like?",
            "Question 2. How often do you play sports?",
            "Question 3. Who do you play sports with?",
            "Question 4. What game do you enjoy most?",
            "Question 5. Do you often watch sports on TV?"
          ],
          part2: ["Question 6. Please tell me about your favorite sport or game."],
          part3: [
            "Question 7. Why are sports important for students?",
            "Question 8. What sports help you stay healthy?",
            "Question 9. Should students play sports every day?",
            "Question 10. What new sport would you like to try?"
          ]
        },
        g6_cities_world: {
          part1: [
            "Question 1. What city do you live in?",
            "Question 2. What cities do you know around the world?",
            "Question 3. Which city would you like to visit?",
            "Question 4. Who would you travel with?",
            "Question 5. What do you like doing when visiting a city?"
          ],
          part2: ["Question 6. Please tell me about a city you know."],
          part3: [
            "Question 7. What makes a city beautiful?",
            "Question 8. How can cities become cleaner?",
            "Question 9. Why do people like living in big cities?",
            "Question 10. What city would you like to explore in the future?"
          ]
        },
        g6_houses_future: {
          part1: [
            "Question 1. What is your house like now?",
            "Question 2. What do you want your future house to have?",
            "Question 3. Where would you like your future house to be?",
            "Question 4. Who would you live with in the future?",
            "Question 5. What technology do you want in your future house?"
          ],
          part2: ["Question 6. Please tell me about your future house."],
          part3: [
            "Question 7. Why do people want modern houses?",
            "Question 8. How can smart houses help people?",
            "Question 9. What will houses look like in the future?",
            "Question 10. What future home invention would you like to create?"
          ]
        },
        g6_our_greener_world: {
          part1: [
            "Question 1. What do you do to help the environment?",
            "Question 2. Do you recycle at home?",
            "Question 3. What things do you reuse?",
            "Question 4. Who teaches you about protecting the environment?",
            "Question 5. What green activities do you enjoy?"
          ],
          part2: ["Question 6. Please tell me about ways to make the world greener."],
          part3: [
            "Question 7. Why is it important to protect the environment?",
            "Question 8. What can students do to save energy?",
            "Question 9. How can we reduce pollution?",
            "Question 10. What green habit would you like to start?"
          ]
        },
        g6_robots: {
          part1: [
            "Question 1. Have you ever seen a robot?",
            "Question 2. What can robots do?",
            "Question 3. What type of robot would you like to have?",
            "Question 4. How often do you use technology?",
            "Question 5. What do you want a robot to help you with?"
          ],
          part2: ["Question 6. Please tell me about robots in the future."],
          part3: [
            "Question 7. How can robots help people?",
            "Question 8. Will robots be important in the future?",
            "Question 9. What are the good things about robots?",
            "Question 10. What should students learn if they want to build robots?"
          ]
        }
      };

      /* ===================== SUGGESTED ANSWERS (GRADE 6) =====================
       * - Q1‚Äì5,7‚Äì10: ~30‚Äì45 words (A1)
       * - Q6: ~140‚Äì170 words (A1+), easy
       */
      const SUGGESTED_ANSWERS_6 = {
        g6_my_new_school: {
          1: "My school is Xuan Phu Lower Secondary School. It is a friendly place with many students. I like the school name because it sounds strong and easy to remember.",
          2: "My school is in my hometown. It is near my house, so I can go there quickly. The area is quiet and safe for students.",
          3: "My favourite teacher is my English teacher. She is kind and patient. She explains lessons clearly and always encourages me to speak English.",
          4: "I like English the most. It helps me communicate with people and watch videos in English. I also enjoy learning new words and simple conversations.",
          5: "I go to school by bicycle. It takes about ten minutes. Sometimes my parents take me by motorbike when it rains.",
          6: "My new school is a lower secondary school in my hometown. The school is not too big, but it is clean and beautiful. There are many classrooms, a library, and a school yard where we play at break time. I study many subjects such as Maths, English, Literature, and Science. My teachers are friendly and helpful, so I feel comfortable in class. I have made some new friends, and we often study together after school. I like the English lessons because we can practise speaking and do fun activities. I also like the school rules because they help students be polite and responsible. I feel happy to learn in my new school, and I will try my best to become a good student.",
          7: "At break time, I usually chat with my friends and play simple games. Sometimes I walk around the school yard. It helps me relax after studying.",
          8: "Yes, I think school uniforms are important. They make students look equal and tidy. Uniforms also help us feel we belong to our school.",
          9: "A good student is polite, hard-working, and honest. He or she listens to teachers and does homework on time. A good student also helps classmates when they need support.",
          10:"I would like to have more English clubs and more interesting activities. I also want more trees in the school yard. That can make the school cooler and greener."
        },

        g6_my_house: {
          1: "I live in a small town in Viet Nam. My house is in a quiet street. I like my place because it is peaceful and comfortable.",
          2: "There are five rooms in my house: a living room, two bedrooms, a kitchen, and a bathroom. The rooms are simple but clean.",
          3: "I like my bedroom the most. It is my private space to study and relax. I keep my books and some pictures there.",
          4: "I live with my parents and my siblings. We usually have meals together. My family is small but very close.",
          5: "At home, I often do homework and help my parents. In my free time, I read books or listen to music. Sometimes I watch cartoons.",
          6: "My house is not very big, but it is warm and comfortable. There is a living room where my family watches TV together. The kitchen is small, but my mother cooks delicious food there. I have a bedroom to study and sleep. I keep my desk tidy and put my books on a shelf. My house is near my school, so I can go to school easily. I like the space in front of my house because I can sit there and enjoy fresh air in the afternoon. My family often clean the house at the weekend. I think a clean house makes us feel happy and healthy. I love my house because it is where my family lives and shares good moments every day.",
          7: "It is important to keep the house clean because it can prevent diseases. A clean house also looks nice and comfortable. It helps family members feel relaxed.",
          8: "I prefer living in a house because it is quiet and has more space. I can open windows and enjoy fresh air. It also feels warm and private.",
          9: "My dream house would be bigger and brighter. It would have a small garden with flowers. I also want a study room and a smart TV.",
          10:"I help my family by sweeping the floor and washing dishes. Sometimes I tidy my room and fold clothes. I also try to be polite and listen to my parents."
        },

        g6_my_friends: {
          1: "My best friend is Lan. She is in my class and sits next to me. She is friendly and always smiles.",
          2: "I met my best friend at school on the first day. We talked about our hobbies. After that, we became close friends.",
          3: "We usually study together and share notes. Sometimes we play badminton after school. At weekends, we chat online.",
          4: "I like my friends because they are kind and helpful. They listen to me and support me. We respect each other.",
          5: "I see my friends every day at school. We also meet after school sometimes. I feel happy when I am with them.",
          6: "I am lucky because I have some good friends at school. My best friend is friendly, honest, and hard-working. We often study together and help each other with homework. When I don‚Äôt understand a lesson, my friend explains it again in a simple way. We also have fun together at break time. We play games, talk about our favourite subjects, and share snacks. I think friendship is important because friends make us feel less lonely. They can encourage us when we are sad or tired. I always try to be a good friend too. I listen carefully, keep secrets, and say sorry when I make a mistake. I hope our friendship will last for a long time.",
          7: "A good friend is kind and honest. He or she helps you when you have problems. A good friend also respects you and shares happy moments with you.",
          8: "I think it is good to have a few close friends, not too many. Close friends understand you better. But having many friends can also help you learn new things.",
          9: "When my friends have a problem, I listen to them first. I try to comfort them and give simple advice. If it is serious, I tell a teacher or parents.",
          10:"Activities like group work, clubs, and sports help students make new friends. Students can talk more and cooperate. They can understand each other better."
        },

        g6_my_neighbourhood: {
          1: "I live in a small town, not in a big city. My area is quiet and friendly. People know each other well.",
          2: "My neighbourhood is clean and not too noisy. There are some small shops and many houses. I feel safe living here.",
          3: "Near my house, there is a market and a pharmacy. There is also a small park. I often go there in the afternoon.",
          4: "I often meet my neighbours and my friends. People usually say hello and smile. They are kind to my family.",
          5: "I like the peaceful atmosphere the most. The streets are not crowded. It is a good place for students to study and rest.",
          6: "I live in a small neighbourhood in my hometown. It is a quiet and friendly place. There are many houses, and people often greet each other when they meet. Near my house, there is a small market where my mother buys food every morning. There is also a park where children can play and do exercise. In the evening, many people walk around and talk with friends. I like my neighbourhood because it is safe and not too noisy. The streets are clean, and there are some trees, so the air is fresh. Sometimes my neighbours help my family, and my family also helps them. I think living in a good neighbourhood makes people feel happy and comfortable.",
          7: "A good neighbourhood is clean, safe, and friendly. People respect each other and follow the rules. It should also have useful places like shops and parks.",
          8: "Yes, students should help keep the neighbourhood clean. We can throw rubbish in bins and pick up litter. Small actions can make the area better.",
          9: "People can make a neighbourhood safer by turning on street lights and keeping streets clean. They can also report bad activities. Neighbours should help each other.",
          10:"I want more trees and more rubbish bins. I also want a bigger playground for children. These changes can improve our life."
        },

        g6_natural_wonders: {
          1: "Yes, I have visited a beautiful beach before. I felt excited and relaxed. The view was amazing.",
          2: "I know Ha Long Bay. It is famous for many islands and caves. Many tourists visit it every year.",
          3: "I would like to visit Son Doong Cave one day. It looks huge and special. I want to see it with my own eyes.",
          4: "I would go with my family or my best friends. Traveling together is fun. We can share good memories.",
          5: "I feel happy and peaceful when I visit beautiful places. Nature makes me feel fresh. I enjoy taking photos too.",
          6: "Viet Nam has many beautiful natural wonders. One famous place is Ha Long Bay. It is in Quang Ninh province and has thousands of small islands on the sea. The view is wonderful, especially in the early morning. Tourists can take a boat trip, visit caves, and enjoy fresh seafood. Another amazing natural wonder is Son Doong Cave. It is very large and has unique rocks and underground rivers. I think natural wonders are important because they show the beauty of our country. We should protect them by keeping the environment clean, not throwing rubbish, and following the rules when we travel. I hope more people will love nature and help protect these places for the future.",
          7: "We should protect natural wonders because they are precious and beautiful. They also attract tourists and help local people. If we damage them, we cannot get them back.",
          8: "Tourism can bring money and jobs, but it can also cause pollution. If tourists throw rubbish, nature becomes dirty. We need good rules to protect the environment.",
          9: "Students can promote natural wonders by sharing information and photos. We can join clean-up activities and tell others not to litter. We can also learn about these places in school.",
          10:"In the future, I want to explore more national parks and caves. I also want to visit mountains and islands. I think nature trips are exciting and meaningful."
        },

        g6_our_tet_holiday: {
          1: "During Tet, I usually clean my house and decorate it. I also visit my relatives. Tet is a happy time for my family.",
          2: "At Tet, I eat banh chung and many traditional dishes. I also eat sweets and fruits. The food is very delicious.",
          3: "I visit my grandparents and my aunts and uncles. I say happy new year to them. I enjoy family gatherings.",
          4: "I enjoy watching fireworks and receiving lucky money. I also like wearing new clothes. Tet activities are fun and exciting.",
          5: "At Tet, I like getting lucky money the most. It makes me happy. I usually save it for school things.",
          6: "Tet is the most important holiday in Viet Nam. Before Tet, my family clean the house and decorate it with flowers like peach blossoms or apricot blossoms. My mother cooks traditional food such as banh chung, spring rolls, and special meat dishes. On Tet days, I wear new clothes and visit my grandparents and relatives. We say ‚ÄúHappy New Year‚Äù and give good wishes. Children often receive lucky money in red envelopes. I like Tet because I can spend more time with my family and feel the warm atmosphere. Tet is also a time to start a new year with hope. I think we should keep Tet traditions because they are beautiful and show respect for our family and our culture.",
          7: "Tet is important because it is a time for family reunion. People relax, visit relatives, and give good wishes. It also helps us remember our traditions.",
          8: "People prepare for Tet by cleaning the house and buying new things. They cook traditional food and decorate with flowers. Many people also go shopping for Tet.",
          9: "Children should be polite and greet adults at Tet. They should say thank you when receiving lucky money. They should also help parents with small tasks.",
          10:"We can keep Tet traditions alive by celebrating them with our family. We should teach children about Tet customs. We can also share Tet stories and activities at school."
        },

        g6_television: {
          1: "I watch TV a few times a week. I usually watch it after homework. I don‚Äôt watch too much because I also need to study.",
          2: "My favourite programme is a cartoon show. It is funny and easy to understand. It helps me relax.",
          3: "I usually watch TV with my family. We sit together in the living room. It is a good time to talk and laugh.",
          4: "I watch TV about one hour a day. Sometimes I watch more at the weekend. I try to control my time.",
          5: "I can learn new information from TV, such as science and animals. I also learn some English words. TV can be useful if we choose good programmes.",
          6: "I usually watch TV in the evening after I finish my homework. I often watch for about one hour because I don‚Äôt want it to affect my studies. My favourite programmes are cartoons and educational shows. Cartoons help me relax, and educational programmes teach me new things about nature, science, or culture. Sometimes I watch the news with my parents to know what is happening. I think watching TV is good if we use it wisely. We should sit at a safe distance, not watch too late, and choose useful programmes. When I have free time at the weekend, I may watch a movie with my family. Watching TV together makes us closer and gives us something fun to talk about.",
          7: "Watching TV can be good if students choose useful programmes. It helps them relax and learn new things. But watching too much is not good for health and study.",
          8: "Students should watch educational programmes, cartoons with good messages, and news for children. These programmes can help students learn and improve language. They should avoid violent content.",
          9: "We can use TV time wisely by setting a time limit. We should finish homework first. We can also watch English programmes to practise listening.",
          10:"Yes, I think TV will change in the future. It may be smarter and more interactive. People may watch more online, not only on TV screens."
        },

        g6_sports_games: {
          1: "I like badminton and football. They are fun and help me stay healthy. I feel happy when I play sports.",
          2: "I play sports two or three times a week. I often play after school. It helps me relax and reduce stress.",
          3: "I play sports with my friends and classmates. Sometimes I play with my family at the weekend. Playing together is more exciting.",
          4: "I enjoy badminton the most. It is easy to play and very active. I can play it in the school yard.",
          5: "Yes, I sometimes watch sports on TV, especially football matches. I like cheering for my favourite team. It is exciting.",
          6: "My favourite sport is badminton. I like it because it is easy to play and very good for my health. I often play badminton with my friends after school. We usually play in the school yard or near my house. When I play badminton, I feel active and happy. It helps me become stronger and more flexible. I also learn how to cooperate and follow rules. Sometimes I watch badminton or football on TV to learn new skills and enjoy the games. I think sports are important for students because they help us stay healthy and study better. In the future, I want to practise more and play sports regularly.",
          7: "Sports are important for students because they improve health and strength. They also help students relax. Sports can teach teamwork and discipline too.",
          8: "Sports like running, badminton, and swimming help us stay healthy. They make our heart and muscles stronger. They also improve our mood.",
          9: "Yes, students should play sports every day if possible. Even 15‚Äì30 minutes is good. It helps students have more energy and focus.",
          10:"I would like to try swimming or basketball more often. These sports look fun and challenging. I think learning a new sport is exciting."
        },

        g6_cities_world: {
          1: "I live in a small city in Viet Nam. It is not too crowded. People are friendly and life is peaceful.",
          2: "I know some famous cities like Ha Noi, Ho Chi Minh City, Tokyo, and London. They are popular for culture and modern life. I learn about them from books and TV.",
          3: "I would like to visit Tokyo. It looks modern and clean. I also want to see the beautiful places and try the food.",
          4: "I would travel with my family. Traveling together is safer and more fun. We can share good memories.",
          5: "When visiting a city, I like walking around and taking photos. I also enjoy trying local food. I like visiting famous landmarks too.",
          6: "There are many interesting cities in the world. In Viet Nam, Ha Noi and Ho Chi Minh City are very famous. Ha Noi has many old streets and beautiful lakes. Ho Chi Minh City is busy and has many tall buildings and shopping centres. Around the world, I also know cities like Tokyo and London. These cities are modern and have many attractions for tourists. I like cities because they have convenient services, good schools, and many places to visit. However, some big cities are crowded and noisy. I think a good city should be clean, safe, and green. In the future, I hope I can visit a big city and learn more about different cultures.",
          7: "A city is beautiful when it is clean and has many green trees. It should have nice buildings and good parks. People should also be friendly and polite.",
          8: "Cities can become cleaner by putting more rubbish bins and collecting rubbish regularly. People should not litter. We can also plant more trees and reduce pollution.",
          9: "People like living in big cities because there are more jobs and good schools. Cities also have convenient services like hospitals and shops. Life can be more exciting.",
          10:"I would like to explore more cities in Viet Nam and in the world. I want to see different cultures and try new food. Traveling can help me learn a lot."
        },

        g6_houses_future: {
          1: "My house now is simple and comfortable. It has enough rooms for my family. I feel safe living there.",
          2: "In the future, I want my house to have a small garden and a big kitchen. I also want a bright study room. These things can make life better.",
          3: "I would like my future house to be near the sea or in the countryside. The air is fresh there. It is also quiet and relaxing.",
          4: "In the future, I want to live with my family. I want to take care of my parents. Living together makes us close.",
          5: "I want smart lights and a smart TV in my future house. I also want a robot to help with cleaning. Technology can save time.",
          6: "In the future, I think houses will be smarter and more convenient. My future house will be modern and comfortable. It will have a large living room and a bright bedroom. I also want a small garden with flowers and trees. In my future house, I want smart technology such as automatic lights and air conditioners. When it is hot, the air conditioner can turn on by itself. I also want a robot to help clean the floor and wash dishes. My future house will use solar energy to save electricity and protect the environment. I hope my house will be in a quiet place with fresh air, maybe in the countryside or near the sea. A good future house can help people live more comfortably and happily.",
          7: "People want modern houses because they are comfortable and convenient. Modern houses can save time and energy. They can also be safer with smart systems.",
          8: "Smart houses can help people control lights and temperature easily. They can also improve safety with cameras and alarms. Smart houses can save electricity too.",
          9: "I think houses will have more smart devices in the future. They may use clean energy like solar power. Houses may also have robots to help with chores.",
          10:"I would like to create a smart robot cleaner for my future home. It can clean the house quickly. It can help busy parents and students."
        },

        g6_our_greener_world: {
          1: "I help the environment by not littering. I also save water and electricity. Small actions can make a difference.",
          2: "Yes, I recycle at home sometimes. I separate plastic bottles and paper. Recycling can reduce rubbish.",
          3: "I reuse plastic bags and some containers. I also reuse notebooks if they still have blank pages. Reusing helps save resources.",
          4: "My parents and teachers teach me about protecting the environment. We also learn from TV and books. I try to follow their advice.",
          5: "I enjoy planting trees and cleaning my room. I also like picking up litter in my neighbourhood. These activities make me feel useful.",
          6: "I think everyone can do something to make the world greener. First, we should reduce rubbish by using fewer plastic bags and bottles. We can bring our own bottle and use a cloth bag when shopping. Second, we should reuse and recycle. For example, we can reuse paper and separate plastic, glass, and cans for recycling. Third, we should save energy by turning off lights and fans when we don‚Äôt use them. Saving water is also important. In addition, we can plant more trees because trees make the air cleaner and cooler. Students can join clean-up activities at school or in the neighbourhood. If many people do small actions every day, our world will become greener and healthier for the future.",
          7: "Protecting the environment is important because it keeps our air and water clean. It also helps animals and plants. A clean environment makes people healthier.",
          8: "Students can save energy by turning off lights and computers when not used. They can use fans instead of air conditioners. They can also study in natural light.",
          9: "We can reduce pollution by using public transport and not burning rubbish. We should plant trees and keep streets clean. Factories should follow environmental rules too.",
          10:"I want to start a habit of using less plastic. I will use a reusable bottle and bag. I will also remind my friends not to litter."
        },

        g6_robots: {
          1: "Yes, I have seen robots on TV and in videos. They look interesting and modern. I want to see a real robot in the future.",
          2: "Robots can clean the house and help people in factories. Some robots can teach or answer questions. Robots can also help in hospitals.",
          3: "I would like to have a robot that can clean my room. It can sweep the floor and tidy my desk. It can save me time.",
          4: "I use technology every day, such as a smartphone or a computer. I use it for learning and entertainment. I try not to use it too much.",
          5: "I want a robot to help me do homework and learn English. It can explain words and practise speaking with me. That would be very useful.",
          6: "Robots are becoming more popular in modern life. I think robots can help people in many ways. For example, robots can work in factories and do hard or dangerous jobs. At home, a robot can clean the floor, wash dishes, or help old people. In hospitals, robots can support doctors and nurses. In the future, I want to have a robot at home. It can help me do simple chores so I have more time to study and relax. However, I think people should use robots in a good way. Robots cannot replace love and care from humans. If we use robots wisely, they can make our life easier and more comfortable.",
          7: "Robots can help people by doing difficult jobs and saving time. They can also work in dangerous places. This can protect humans and improve safety.",
          8: "Yes, robots will be important in the future because technology is developing fast. Robots can support work at home and in factories. They can also help in education and health.",
          9: "Robots are useful because they can work quickly and do repeated tasks. They can help people save time. They can also assist old people and disabled people.",
          10:"Students should learn Science and Technology if they want to build robots. Maths is also important. Learning programming can help students control robots."
        }
      };

      /* ========== DOM ========== */
      const gradeSelect = document.getElementById("gradeSelect");
      const topicSelect = document.getElementById("topicSelect");
      const partSelect  = document.getElementById("partSelect");
      const questionList = document.getElementById("questionList");
      const questionTextarea = document.getElementById("question");
      const questionTextContainer = document.getElementById("questionTextContainer");
      const showTextBtn = document.getElementById("showTextBtn");
      const speakQuestionBtn = document.getElementById("speakQuestionBtn");
      const answerText = document.getElementById("answerText");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const sendBtn = document.getElementById("sendBtn");
      const suggestBtn = document.getElementById("suggestBtn");
      const suggestionsArea = document.getElementById("suggestionsArea");
      const resultArea = document.getElementById("resultArea");
      const clearBtn = document.getElementById("clearBtn");
      const statusEl = document.getElementById("status");
      const uploadProgress = document.getElementById("uploadProgress");
      const progressBar = document.getElementById("progressBar");
      const progressPercent = document.getElementById("progressPercent");
      const timerBox = document.getElementById("timerBox");
      const timerText = document.getElementById("timerText");
      const timerInline = document.getElementById("timerInline");
      const leaveHint = document.getElementById("leaveHint");

      const pendingBox = document.getElementById("pendingBox");
      const pendingInfo = document.getElementById("pendingInfo");
      const resendPendingBtn = document.getElementById("resendPendingBtn");
      const clearPendingBtn = document.getElementById("clearPendingBtn");

      // ========== state ==========
      let isRecording = false;
      let ignore_onend = false;

      // ======= unified audio recorder =======
      let recorderMode = "";          // "media" or "wav"
      let isFullRecordingStarted = false;
      let audioMimeType = "";
      let micStream = null;

      // B·∫Øt bu·ªôc ƒë·ªß 10 c√¢u
      let recordedFlags = new Array(TOTAL_QUESTIONS).fill(false);

      // ======= question state =======
      let questionTexts = new Array(TOTAL_QUESTIONS).fill("");
      let answers = new Array(TOTAL_QUESTIONS).fill("");
      let currentQuestionIndex = 0;
      let hasCompletedTopic = false;

      // ===================== API CALL =====================
      async function callScriptApiNoCors(action, payload) {
        const body = JSON.stringify({ action, ...payload });
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          redirect: "follow",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          keepalive: false,
          body
        });
        return { ok: true, message: "ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV ƒë·ªÉ x√°c nh·∫≠n." };
      }

      async function submitWithRetry(payload) {
        let lastErr = null;
        for (let i = 0; i < 2; i++) {
          try {
            const r = await callScriptApiNoCors("submitAll", payload);
            if (r && r.ok) return { ok: true, r, channel: "no-cors" };
            lastErr = new Error((r && r.message) ? r.message : "Request failed");
          } catch (e) { lastErr = e; }
          await sleep(600 * (i + 1));
        }
        return { ok: false, error: lastErr };
      }

      function savePending(payload) {
        try {
          const obj = { payload, savedAt: new Date().toISOString() };
          localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
          showPendingBox();
        } catch(e) {}
      }

      function clearPending() {
        try { localStorage.removeItem(PENDING_KEY); } catch(e) {}
        pendingBox.style.display = "none";
      }

      function getPending() {
        try {
          const s = localStorage.getItem(PENDING_KEY);
          if (!s) return null;
          return JSON.parse(s);
        } catch(e) { return null; }
      }

      function showPendingBox() {
        const p = getPending();
        if (!p || !p.payload) { pendingBox.style.display = "none"; return; }
        pendingBox.style.display = "block";
        const dt = p.savedAt ? new Date(p.savedAt) : null;
        const when = dt ? dt.toLocaleString("vi-VN") : "(unknown time)";
        const payload = p.payload || {};
        const name = payload.studentName || (payload.meta && payload.meta.studentName) || "";
        const cls  = payload.studentClass || (payload.meta && payload.meta.studentClass) || "";
        const mode = payload.__pendingMode || "normal";
        pendingInfo.textContent = `H·ªç t√™n: ${name} | L·ªõp: ${cls} | L∆∞u l√∫c: ${when}` + (mode === "chunk" ? " | (C√≥ k√®m audio ƒë·ªÉ g·ª≠i l·∫°i)" : "");
      }

      async function resendPendingChunk(payload) {
        const audioKey = payload.audioKey;
        const mimeType = payload.mimeType || "audio/webm";
        const meta = payload.meta || {};
        if (!audioKey) throw new Error("Missing audioKey");
        const blob = await idbGetBlob(audioKey);
        if (!blob) throw new Error("Audio blob not found (IndexedDB)");
        resultArea.textContent = "ƒêang g·ª≠i l·∫°i audio ƒë√£ l∆∞u...";
        leaveHint.style.display = "block";
        await uploadAudioInChunksNoCors(blob, mimeType, meta);
        await idbDelBlob(audioKey);
        clearPending();
        resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i l·∫°i th√†nh c√¥ng (k√®m audio)!</span>';
      }

      resendPendingBtn.onclick = async () => {
        const p = getPending();
        if (!p || !p.payload) return;

        resultArea.textContent = "ƒêang g·ª≠i l·∫°i b√†i ƒë√£ l∆∞u...";
        resendPendingBtn.disabled = true;
        clearPendingBtn.disabled = true;

        try {
          if (p.payload.__pendingMode === "chunk") {
            await resendPendingChunk(p.payload);
          } else {
            const out = await submitWithRetry(p.payload);
            if (out.ok) {
              clearPending();
              resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i l·∫°i. Vui l√≤ng ki·ªÉm tra email GV.</span>';
            } else {
              resultArea.innerHTML = '<span class="status-error">Ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c. Vui l√≤ng th·ª≠ l·∫°i khi m·∫°ng ·ªïn ƒë·ªãnh.</span>';
            }
          }
        } catch (e) {
          resultArea.innerHTML = '<span class="status-error">Ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c. Vui l√≤ng th·ª≠ l·∫°i khi m·∫°ng ·ªïn ƒë·ªãnh.</span>';
        }

        resendPendingBtn.disabled = false;
        clearPendingBtn.disabled = false;
      };

      clearPendingBtn.onclick = () => {
        if (!confirm("X√≥a b√†i l∆∞u ch∆∞a g·ª≠i?")) return;
        const p = getPending();
        if (p && p.payload && p.payload.__pendingMode === "chunk" && p.payload.audioKey) {
          idbDelBlob(p.payload.audioKey).catch(()=>{});
        }
        clearPending();
      };

      showPendingBox();

      // ======= init selects =======
      GRADES.forEach((g) => {
        const opt = document.createElement("option");
        opt.value = g.id;
        opt.textContent = g.name;
        gradeSelect.appendChild(opt);
      });

      function updateTopics() {
        const g = GRADES.find((x) => x.id === gradeSelect.value);
        topicSelect.innerHTML = "";
        if (g) {
          g.topics.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t.id;
            opt.textContent = t.name + (t.vn ? " - " + t.vn : "");
            topicSelect.appendChild(opt);
          });
        }
      }

      function resetTopicState() {
        questionTexts = new Array(TOTAL_QUESTIONS).fill("");
        answers = new Array(TOTAL_QUESTIONS).fill("");
        currentQuestionIndex = 0;
        hasCompletedTopic = false;
        suggestBtn.disabled = true;
        suggestionsArea.textContent = "";
        answerText.value = "";
        sendBtn.disabled = false;
        statusEl.textContent = 'Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.';
        recordedFlags = new Array(TOTAL_QUESTIONS).fill(false);

        timeLocked = false;
        recordDeadlineTs = null;
        if (recordTimer) { clearInterval(recordTimer); recordTimer = null; }
        timerText.textContent = "08:00";
        timerBox.style.display = "none";
        if (timerInline) {
          timerInline.textContent = "08:00";
          timerInline.style.display = "none";
        }

        speakQuestionBtn.disabled = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      function renderQuestions() {
        const tId = topicSelect.value;
        const data = GRADE_6_QUESTIONS[tId] ? GRADE_6_QUESTIONS[tId] : { part1: [], part2: [], part3: [] };

        const part = partSelect.value;
        const list = part === "part1" ? data.part1 : part === "part2" ? data.part2 : data.part3;

        questionList.innerHTML = "";
        if ("speechSynthesis" in window) window.speechSynthesis.cancel();

        list.forEach((q, idx) => {
          const div = document.createElement("div");
          div.className = "question-item";
          const qNum = part === "part1" ? idx + 1 : part === "part2" ? 6 : idx + 7;
          const qIndex = qNum - 1;
          questionTexts[qIndex] = q;

          div.dataset.qindex = qIndex.toString();
          div.innerHTML = '<span class="q-no">Q' + qNum + '.</span><span>C√¢u h·ªèi ' + qNum + " (Hidden)</span>";

          div.onclick = () => {
            document.querySelectorAll(".question-item").forEach((e) => e.classList.remove("active"));
            div.classList.add("active");

            currentQuestionIndex = qIndex;
            questionTextarea.value = q;
            questionTextContainer.style.display = "none";

            answerText.value = answers[qIndex] || "";

            sendBtn.disabled = false;

            if ("speechSynthesis" in window) window.speechSynthesis.cancel();
            isRecording = false;
            ignore_onend = true;

            startBtn.disabled = timeLocked ? true : false;
            stopBtn.disabled = true;
            statusEl.textContent = timeLocked ? "‚õî H·∫øt th·ªùi gian (8 ph√∫t cho t·ªïng 10 c√¢u)." : 'Nh·∫•n "B·∫Øt ƒë·∫ßu n√≥i" ƒë·ªÉ tr·∫£ l·ªùi.';
          };

          questionList.appendChild(div);
        });

        if (questionList.firstChild) questionList.firstChild.click();
      }

      gradeSelect.onchange = () => { updateTopics(); resetTopicState(); renderQuestions(); };
      topicSelect.onchange = () => { resetTopicState(); renderQuestions(); };
      partSelect.onchange = renderQuestions;

      updateTopics();
      renderQuestions();

      // ======= Step 2 buttons =======
      showTextBtn.onclick = () => { questionTextContainer.style.display = "block"; };
      speakQuestionBtn.onclick = () => { speakText(questionTextarea.value); };

      // ===================== Start/Stop speaking =====================
      startBtn.onclick = async () => {
        if (timeLocked) {
          alert("H·∫øt th·ªùi gian (8 ph√∫t cho t·ªïng 10 c√¢u). B·∫°n kh√¥ng th·ªÉ tr·∫£ l·ªùi th√™m.");
          return;
        }
        if (getRemainingSeconds() <= 0) {
          lockByTimeUp();
          return;
        }

        startCountdownIfNeeded();

        try {
          await startFullRecordingIfNeeded();
          resumeFullRecording();

          recordedFlags[currentQuestionIndex] = true;

          if (recorderMode === "wav") {
            statusEl.textContent = "ƒêang ghi √¢m (WAV fallback ‚Äì iPhone/iPad OK). N√≥i to v√† r√µ.";
          } else {
            statusEl.textContent = "ƒêang ghi √¢m... N√≥i to v√† r√µ.";
          }
        } catch (err) {
          recordedFlags[currentQuestionIndex] = true;
          statusEl.textContent = "Kh√¥ng th·ªÉ kh·ªüi t·∫°o ghi √¢m. Vui l√≤ng ki·ªÉm tra quy·ªÅn Microphone.";
          return;
        }

        isRecording = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusEl.textContent = "ƒêang ghi √¢m... H√£y n√≥i c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.";
      };

      stopBtn.onclick = () => {
        if (timeLocked) return;

        isRecording = false;
        ignore_onend = true;

        pauseFullRecording();

        let currentAns = answerText.value.trim();
        if (currentAns) {
          if (!/[.!?]$/.test(currentAns)) currentAns += ".";
          answers[currentQuestionIndex] = currentAns;
          answerText.value = currentAns;
        }

        setTimeout(() => {
          const activeItem = document.querySelector(".question-item.active");

          if (activeItem && activeItem.nextElementSibling) {
            activeItem.nextElementSibling.click();
            const nextText = questionTextarea.value;
            if (nextText) {
              speakText(nextText);
              statusEl.textContent = "ƒê√£ chuy·ªÉn c√¢u & ƒêang ƒë·ªçc c√¢u h·ªèi...";
            }
          } else {
            const partOrder = ["part1", "part2", "part3"];
            const idx = partOrder.indexOf(partSelect.value);

            if (idx !== -1 && idx < partOrder.length - 1) {
              partSelect.value = partOrder[idx + 1];
              renderQuestions();
              const nextText = questionTextarea.value;
              if (nextText) {
                speakText(nextText);
                statusEl.textContent = "ƒê√£ chuy·ªÉn sang ph·∫ßn m·ªõi & ƒêang ƒë·ªçc c√¢u h·ªèi...";
              } else {
                statusEl.textContent = "ƒê√£ chuy·ªÉn sang ph·∫ßn m·ªõi.";
              }
            } else {
              statusEl.textContent = "ƒê√£ h·∫øt t·∫•t c·∫£ c√¢u h·ªèi c·ªßa ch·ªß ƒë·ªÅ n√†y.";
              hasCompletedTopic = true;
              suggestBtn.disabled = false;
            }
          }

          startBtn.disabled = timeLocked ? true : false;
          stopBtn.disabled = true;
        }, 1200);
      };

      clearBtn.onclick = () => {
        if (!confirm("B·∫°n mu·ªën x√≥a h·∫øt n·ªôi dung v·ª´a n√≥i ƒë·ªÉ l√†m l·∫°i?")) return;

        isRecording = false;
        ignore_onend = true;

        answerText.value = "";
        answers[currentQuestionIndex] = "";

        sendBtn.disabled = false;

        statusEl.textContent = "ƒê√£ x√≥a. Nh·∫•n B·∫Øt ƒë·∫ßu n√≥i ƒë·ªÉ l√†m l·∫°i.";
        startBtn.disabled = timeLocked ? true : false;
        stopBtn.disabled = true;

        hasCompletedTopic = false;
        suggestBtn.disabled = true;
        suggestionsArea.textContent = "";

        recordedFlags[currentQuestionIndex] = false;
      };

      // ===================== SEND (NO MP3, compatible Code.gs) =====================
      sendBtn.onclick = () => {
        let currentAns = answerText.value.trim();
        if (currentAns) {
          if (!/[.!?]$/.test(currentAns)) currentAns += ".";
          answers[currentQuestionIndex] = currentAns;
          answerText.value = currentAns;
        }

        if (!hasCompletedTopic) {
          alert("B·∫°n c·∫ßn ƒë·ªÉ ·ª©ng d·ª•ng ch·∫°y h·∫øt 10 c√¢u h·ªèi (c·∫£ 3 ph·∫ßn) r·ªìi m·ªõi n·ªôp b√†i cho gi√°o vi√™n.");
          return;
        }

        if (!allTenQuestionsRecorded()) {
          alert("B·∫°n ph·∫£i b·∫•m 'B·∫Øt ƒë·∫ßu n√≥i' v√† tr·∫£ l·ªùi ƒë·ªß 10 c√¢u (Q1‚ÜíQ10) th√¨ m·ªõi n·ªôp ƒë∆∞·ª£c b√†i.");
          return;
        }

        const n = document.getElementById("studentName").value;
        const c = document.getElementById("studentClass").value;
        const tOpt = document.querySelector("#topicSelect option:checked");
        const topicLabel = tOpt ? tOpt.text : "Topic";

        if (!n || !c) {
          alert("Thi·∫øu H·ªç t√™n ho·∫∑c L·ªõp.");
          return;
        }

        const fullTranscript = "";
        const questionSummary = `${topicLabel} ‚Äì 10-question speaking practice`;

        sendBtn.disabled = true;
        resultArea.textContent = "ƒêang x·ª≠ l√Ω audio...";
        pauseFullRecording();
        leaveHint.style.display = "block";

        const sendTranscriptOnly = async () => {
          resultArea.textContent = "ƒêang n·ªôp b√†i (kh√¥ng c√≥ audio)...";
          const payload = {
            studentName: n, studentClass: c, topicLabel,
            questionSummary, transcript: fullTranscript,
            mimeType: "", dataUrl: ""
          };
          const out = await submitWithRetry(payload);
          sendBtn.disabled = false;

          if (out.ok) {
            resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV.</span>';
          } else {
            savePending(payload);
            resultArea.innerHTML = '<span class="status-error">Tr√¨nh duy·ªát ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c vi·ªác n·ªôp b√†i. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u" v√† ki·ªÉm tra email GV.</span>';
          }
        };

        if (!isFullRecordingStarted) {
          sendTranscriptOnly();
          return;
        }

        stopFullRecording((blob) => {
          (async () => {
            try {
              if (!blob || !blob.size) {
                sendBtn.disabled = false;
                resultArea.innerHTML = '<span class="status-error">Kh√¥ng t·∫°o ƒë∆∞·ª£c file ghi √¢m. Vui l√≤ng th·ª≠ l·∫°i.</span>';
                return;
              }

              const finalBlob = blob;
              const mime = (finalBlob.type || audioMimeType || "audio/webm");
              const sizeMB = (finalBlob.size / (1024 * 1024)).toFixed(2);

              // 1) Blob nh·ªè: g·ª≠i dataUrl
              if (finalBlob.size <= SMALL_BLOB_MAX) {
                resultArea.textContent = `Audio ${sizeMB}MB: ƒëang chu·∫©n b·ªã g·ª≠i...`;

                const dataUrl = await new Promise((resolve) => { blobToDataUrl(finalBlob, resolve); });
                if (!dataUrl) {
                  sendBtn.disabled = false;
                  resultArea.innerHTML = '<span class="status-error">L·ªói chuy·ªÉn ƒë·ªïi audio. Vui l√≤ng th·ª≠ l·∫°i.</span>';
                  return;
                }

                let finalDataUrl = dataUrl;
                let finalMime = mime;
                if (finalDataUrl.length > MAX_DATAURL_CHARS) {
                  finalDataUrl = "";
                  finalMime = "";
                }

                const payload = {
                  studentName: n, studentClass: c, topicLabel,
                  questionSummary,
                  transcript: fullTranscript,
                  mimeType: finalMime,
                  dataUrl: finalDataUrl
                };

                if (finalDataUrl) savePending(payload);

                resultArea.textContent = finalDataUrl
                  ? "ƒêang n·ªôp b√†i (audio + transcript)..."
                  : "Audio qu√° l·ªõn (base64). ƒêang n·ªôp b√†i (kh√¥ng k√®m audio)...";

                const out = await submitWithRetry(payload);
                sendBtn.disabled = false;

                if (out.ok) {
                  clearPending();
                  resultArea.innerHTML = finalDataUrl
                    ? '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV (s·∫Ω c√≥ link audio).</span>'
                    : '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu (kh√¥ng k√®m audio). Vui l√≤ng ki·ªÉm tra email GV.</span>';
                } else {
                  savePending(payload);
                  resultArea.innerHTML = '<span class="status-error">Tr√¨nh duy·ªát ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c vi·ªác n·ªôp b√†i. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u" v√† ki·ªÉm tra email GV.</span>';
                }
                return;
              }

              // 2) Blob l·ªõn: chunk upload + l∆∞u an to√†n ƒë·ªÉ resend
              resultArea.textContent = `Audio ${sizeMB}MB: ƒëang chia nh·ªè & upload...`;
              statusEl.textContent = 'ƒêang g·ª≠i b√†i... B·∫°n c√≥ th·ªÉ r·ªùi kh·ªèi trang trong khi qu√° tr√¨nh g·ª≠i b√†i ƒëang di·ªÖn ra.';

              const audioKey = `AUDIO_${Date.now()}_${Math.random().toString(16).slice(2)}`;
              try { await idbSetBlob(audioKey, finalBlob); } catch(e) {}

              const meta = {
                studentName: n,
                studentClass: c,
                topicLabel,
                questionSummary,
                transcript: fullTranscript
              };

              savePending({
                __pendingMode: "chunk",
                audioKey,
                mimeType: mime,
                meta,
                studentName: n,
                studentClass: c
              });

              try {
                await uploadAudioInChunksNoCors(finalBlob, mime, meta);
                sendBtn.disabled = false;
                await idbDelBlob(audioKey);
                clearPending();
                resultArea.innerHTML = '<span class="status-ok">ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra email GV (s·∫Ω c√≥ link audio).</span>';
              } catch (e) {
                sendBtn.disabled = false;
                resultArea.innerHTML = '<span class="status-error">Upload ch∆∞a ho√†n t·∫•t/kh√¥ng x√°c nh·∫≠n ƒë∆∞·ª£c. B√†i ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m "G·ª≠i l·∫°i b√†i v·ª´a l∆∞u" v√† ki·ªÉm tra email GV.</span>';
              }
            } catch (e) {
              sendBtn.disabled = false;
              resultArea.innerHTML = '<span class="status-error">C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.</span>';
            }
          })();
        });
      };

      // ===================== SUGGESTIONS BUTTON (FULL Q1‚ÜíQ10) =====================
      suggestBtn.onclick = () => {
        if (!hasCompletedTopic) {
          alert("B·∫°n c·∫ßn ch·∫°y h·∫øt 10 c√¢u (t·ª´ c√¢u 1 ƒë·∫øn c√¢u 10) tr∆∞·ªõc khi xem g·ª£i √Ω ƒë·ªÉ tr√°nh ph·ª• thu·ªôc v√†o b√†i m·∫´u.");
          return;
        }

        const topicId = topicSelect.value;
        const bank = SUGGESTED_ANSWERS_6[topicId];

        if (!bank) {
          suggestionsArea.textContent = "Hi·ªán ch∆∞a c√≥ g·ª£i √Ω tr·∫£ l·ªùi cho ch·ªß ƒë·ªÅ n√†y.";
          return;
        }

        let out = "";
        for (let i = 1; i <= 10; i++) {
          const a = bank[i] || "";
          out += `Q${i}: ${a}\n\n`;
        }
        suggestionsArea.textContent = out.trim();
      };

      // ======= beforeunload warning =======
      window.addEventListener("beforeunload", (e) => {
        const p = getPending();
        if (uploadInProgress || (p && p.payload)) {
          e.preventDefault();
          e.returnValue = "";
          return "";
        }
      });

      // init
      initSpeech();
    </script>
  </body>
</html>
